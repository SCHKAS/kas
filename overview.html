<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financiële Tracker - Overzicht</title>
    <base href="/kas/"> <!-- Belangrijke toevoeging voor juiste paden op GitHub Pages -->
    <link rel="manifest" href="manifest.json"> <!-- Link naar het PWA manifest bestand -->
    <script>
        // Registreer de Service Worker voor PWA functionaliteit
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js voor geluidseffecten -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase SDK imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.transactions = []; // Store transactions globally
        window.isLoading = false; // Nieuwe globale variabele voor laadstatus

        // Make Firestore functions globally available
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.orderBy = orderBy;

        // Tone.js synth voor notificatiegeluid
        let synth;
        window.initAudio = async () => {
            if (!synth) {
                // Initialiseer Tone.js context en synth
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                console.log("Audio context geïnitialiseerd.");
            }
        };

        window.playPingSound = () => {
            if (synth) {
                synth.triggerAttackRelease("C5", "8n"); // Speel een korte C5 noot
            } else {
                console.warn("Audio synth is nog niet geïnitialiseerd.");
            }
        };

        // Initialize Firebase and set up authentication
        window.initFirebase = async () => {
            console.log("initFirebase gestart."); // Debug log
            // Updated app ID for this version to ensure data separation
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'finance-tracker-bulk-app';
            window.__app_id = appId; // Make it globally accessible for Firestore paths
            console.log(`App ID ingesteld: ${window.__app_id}`); // Debug log

            let firebaseConfig = {};

            // De Firebase configuratie is nu direct hieronder geplakt.
            // Deze is afkomstig van jouw Firebase project: schkas-66d27
            firebaseConfig = {
              apiKey: "AIzaSyCORzv-FVt-7ZUxMBUsmaTl9ZAGcgZk8io",
              authDomain: "schkas-66d27.firebaseapp.com",
              projectId: "schkas-66d27",
              storageBucket: "schkas-66d27.firebasestorage.app",
              messagingSenderId: "987453212703",
              appId: "1:987453212703:web:dcee394027367b74df2d2a",
              measurementId: "G-9M60TQGKJZ" // Added measurementId for consistency
            };

            if (Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase configuratie is onvolledig of nog steeds een placeholder. Persistente opslag zal niet werken. Werk firebaseConfig bij met je echte Firebase projectgegevens.");
                // We gaan door met initialisatie om de app niet volledig te breken,
                // maar Firestore-bewerkingen zullen mislukken.
            }

            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            console.log("Firebase app, db, auth geïnitialiseerd."); // Debug log

            // Listen for authentication state changes
            onAuthStateChanged(window.auth, (user) => {
                console.log("onAuthStateChanged callback geactiveerd."); // Debug log
                if (user) {
                    window.userId = user.uid;
                    console.log("Gebruiker geauthenticeerd:", window.userId);
                    window.isAuthReady = true;
                    // Zodra authenticatie klaar is, laad transacties
                    loadTransactions();
                    document.getElementById('currentUserId').textContent = window.userId; // Display user ID
                } else {
                    console.log("Geen gebruiker gevonden, doorsturen naar auth.html."); // Debug log
                    window.location.href = 'auth.html'; // Redirect to login page
                }
                console.log(`isAuthReady ingesteld op ${window.isAuthReady}. userId: ${window.userId}`); // Debug log
            });
        };

        // BTW-percentage (aanpasbaar)
        const VAT_RATE = 0.21; // 21%

        // Categorieën waarop BTW teruggevorderd kan worden voor uitgaven
        const RECOVERABLE_VAT_EXPENSE_CATEGORIES = [
            "Producten",
            "Nutsvoorziening",
            "Boekhouder",
            "Verzekeringen",
            "Marketing",
            "Software",
            "Verbruiksartikelen"
        ];

        /**
         * Navigeert terug naar de landingspagina.
         */
        window.navigateToHome = function() {
            // Nu relatief aan de <base> href
            window.location.href = 'index.html';
        }

        /**
         * Toon/verberg de laadindicator.
         * @param {boolean} show - True om te tonen, false om te verbergen.
         */
        function showLoadingIndicator(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = show ? 'flex' : 'none';
            }
            window.isLoading = show;
            console.log(`Laadindicator: ${show ? 'getoond' : 'verborgen'}`); // Debug log
        }

        /**
         * Laadt transacties van Firestore en luistert naar real-time updates.
         */
        window.loadTransactions = function() {
            console.log("loadTransactions gestart."); // Debug log
            showLoadingIndicator(true); // Toon laadindicator
            if (!window.db || !window.userId) { // Ensure userId is also available
                console.error("Firestore of User ID is niet geïnitialiseerd. Kan transacties niet laden.");
                showLoadingIndicator(false); // Verberg laadindicator bij fout
                return;
            }

            // Gebruik het gedeelde pad voor de collectie
            const transactionsCollectionRef = window.collection(window.db, `artifacts/${window.__app_id}/public/data/transactions`);
            console.log(`Firestore collectie pad: artifacts/${window.__app_id}/public/data/transactions`); // Debug log

            // Gebruik onSnapshot om real-time updates te krijgen
            window.onSnapshot(window.query(transactionsCollectionRef, window.orderBy('timestamp', 'desc')), (snapshot) => {
                console.log("onSnapshot succes callback geactiveerd."); // Debug log
                window.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Transacties geladen/bijgewerkt:", window.transactions);
                updateQuarterOptions();
                displaySummary();
                renderTransactionList();
                generateReports(); // Generate reports after data is loaded
                showLoadingIndicator(false); // Verberg laadindicator na succesvol laden
            }, (error) => {
                console.error("Fout bij laden transacties (onSnapshot error callback):", error); // Debug log
                showLoadingIndicator(false); // Verberg laadindicator bij fout
            });

            document.getElementById('currentUserId').textContent = window.userId ? window.userId : 'Niet ingelogd'; // Display actual user ID
        }

        /**
         * Werkt de dropdown met kwartalen bij op basis van de ingevoerde transacties.
         */
        window.updateQuarterOptions = function() {
            const summaryQuarterSelect = document.getElementById('summaryQuarterSelect');
            const uniqueQuarters = [...new Set(window.transactions.map(t => t.quarter))]; // Haal unieke kwartalen op
            uniqueQuarters.sort(); // Sorteer de kwartalen

            let optionsHtml = '<option value="all">Alle kwartalen</option>';
            uniqueQuarters.forEach(q => {
                optionsHtml += `<option value="${q}">${q}</option>`;
            });
            summaryQuarterSelect.innerHTML = optionsHtml;

            // Selecteer het kwartaal van de laatst toegevoegde transactie, of 'all'
            if (window.transactions.length > 0) {
                // Probeer het meest recente kwartaal te selecteren
                const latestQuarter = window.transactions[0].quarter; // transactions are sorted by timestamp desc
                if (uniqueQuarters.includes(latestQuarter)) {
                    summaryQuarterSelect.value = latestQuarter;
                } else {
                    summaryQuarterSelect.value = 'all';
                }
            } else {
                summaryQuarterSelect.value = 'all';
            }
            displaySummary(); // Zorg ervoor dat de samenvatting direct wordt bijgewerkt
        }

        /**
         * Berekent en toont de samenvatting van inkomsten, uitgaven, BTW en winst
         * voor het geselecteerde kwartaal.
         */
        window.displaySummary = function() {
            const summaryQuarterSelect = document.getElementById('summaryQuarterSelect');
            const selectedQuarter = summaryQuarterSelect.value;
            const currentQuarterDisplay = document.getElementById('currentQuarterDisplay');

            const filteredTransactions = selectedQuarter === 'all'
                ? window.transactions
                : window.transactions.filter(t => t.quarter === selectedQuarter);

            let totalTreatments = 0;
            let totalSales = 0;
            let totalExpenses = 0;
            let totalRecoverableVATOnExpenses = 0; // Nieuwe variabele voor terug te vorderen BTW

            filteredTransactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0; // Zorg ervoor dat amount een nummer is
                if (t.type === 'income') {
                    // Alleen meetellen als de betalingsmethode NIET 'Cadeaubon' of 'Abonnement' is
                    if (t.paymentMethod !== 'Cadeaubon' && t.paymentMethod !== 'Abonnement') {
                        if (t.category === 'treatments') {
                            totalTreatments += amount;
                        } else if (t.category === 'sales') {
                            totalSales += amount;
                        }
                    }
                } else if (t.type === 'expense') {
                    totalExpenses += amount;
                    // Controleer of de subcategorie in de lijst van terugvorderbare BTW-categorieën staat
                    if (RECOVERABLE_VAT_EXPENSE_CATEGORIES.includes(t.subcategory)) {
                        totalRecoverableVATOnExpenses += amount * VAT_RATE;
                    }
                }
            });

            const totalIncome = totalTreatments + totalSales;
            const totalVAT = totalIncome * VAT_RATE;
            // Pas de winstberekening aan om de teruggevorderde BTW mee te nemen
            const totalProfit = totalIncome - totalExpenses - totalVAT + totalRecoverableVATOnExpenses;

            document.getElementById('totalTreatments').textContent = `€ ${totalTreatments.toFixed(2)}`;
            document.getElementById('totalSales').textContent = `€ ${totalSales.toFixed(2)}`;
            document.getElementById('totalIncome').textContent = `€ ${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `€ ${totalExpenses.toFixed(2)}`;
            document.getElementById('totalRecoverableVATOnExpenses').textContent = `€ ${totalRecoverableVATOnExpenses.toFixed(2)}`; // Toon terug te vorderen BTW
            document.getElementById('totalVAT').textContent = `€ ${totalVAT.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `€ ${totalProfit.toFixed(2)}`;

            currentQuarterDisplay.textContent = selectedQuarter === 'all' ? 'Alle Kwartalen' : selectedQuarter;
        }

        /**
         * Rendert de lijst van alle transacties in een tabel.
         */
        window.renderTransactionList = function() {
            const transactionListBody = document.getElementById('transactionListBody');
            transactionListBody.innerHTML = ''; // Maak de lijst leeg

            window.transactions.forEach(t => {
                const row = transactionListBody.insertRow();
                // Gebruik data-label attributen voor mobiele weergave
                row.insertCell().setAttribute('data-label', 'Kwartaal:');
                row.cells[0].textContent = t.quarter;

                row.insertCell().setAttribute('data-label', 'Type:');
                row.cells[1].textContent = t.type === 'income' ? 'Inkomst' : 'Uitgave';

                row.insertCell().setAttribute('data-label', 'Categorie:');
                row.cells[2].textContent = t.category || 'N.v.t.';

                row.insertCell().setAttribute('data-label', 'Subcategorie:');
                row.cells[3].textContent = t.subcategory || 'N.v.t.';

                row.insertCell().setAttribute('data-label', 'Betaling:');
                row.cells[4].textContent = t.paymentMethod || 'N.v.t.';

                row.insertCell().setAttribute('data-label', 'Bedrag (€):');
                row.cells[5].textContent = `€ ${parseFloat(t.amount || 0).toFixed(2)}`; // Zorg voor een default waarde en formatteer

                row.insertCell().setAttribute('data-label', 'Klantnaam:');
                row.cells[6].textContent = t.customerName || 'N.v.t.';

                row.insertCell().setAttribute('data-label', 'Productnaam:');
                row.cells[7].textContent = t.productName || 'N.v.t.';

                row.insertCell().setAttribute('data-label', 'Factuurdatum:');
                row.cells[8].textContent = t.invoiceDate || 'N.v.t.';

                row.insertCell().setAttribute('data-label', 'Opmerkingen:');
                row.cells[9].textContent = t.remarks || 'N.v.t.';

                row.insertCell().setAttribute('data-label', 'Datum Ingave:');
                row.cells[10].textContent = new Date(t.timestamp).toLocaleDateString('nl-NL');

                row.insertCell().setAttribute('data-label', 'Ingevoerd Door:');
                row.cells[11].textContent = t.person || 'Onbekend';

                const actionsCell = row.insertCell();
                actionsCell.setAttribute('data-label', 'Acties:'); // Label voor acties
                const editButton = document.createElement('button');
                editButton.textContent = 'Bewerken';
                editButton.className = 'edit-btn';
                // This will redirect to the input page with the transaction ID
                editButton.onclick = () => window.location.href = `input.html?editId=${t.id}`; // Nu relatief aan de <base> href
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Verwijderen';
                deleteButton.className = 'delete-btn';
                deleteButton.onclick = () => deleteTransaction(t.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        /**
         * Verwijdert een transactie uit Firestore.
         * @param {string} id - De ID van de transactie die verwijderd moet worden.
         */
        window.deleteTransaction = async function(id) {
            if (!window.db || !window.userId) { // Ensure userId is available
                console.error("Firestore of User ID is niet geïnitialiseerd. Kan transactie niet verwijderen.");
                return;
            }
            // Vervang confirm() door een custom modal UI
            const confirmDelete = await showCustomConfirm("Weet je zeker dat je deze transactie wilt verwijderen?");
            if (!confirmDelete) {
                return;
            }
            showLoadingIndicator(true); // Toon laadindicator
            try {
                // Gebruik het gedeelde pad voor de collectie
                const transactionRef = window.doc(window.db, `artifacts/${window.__app_id}/public/data/transactions`, id);
                await window.deleteDoc(transactionRef);
                console.log("Transactie succesvol verwijderd:", id);
                window.playPingSound(); // Speel geluid na succesvolle verwijdering
            } catch (e) {
                console.error("Fout bij verwijderen transactie:", e);
            } finally {
                showLoadingIndicator(false); // Verberg laadindicator altijd aan het einde
            }
        }

        /**
         * Genereert en toont verschillende rapporten.
         */
        function generateReports() {
            const currentQuarterSelect = document.getElementById('summaryQuarterSelect');
            const selectedQuarter = currentQuarterSelect.value;

            const filteredTransactions = selectedQuarter === 'all'
                ? window.transactions
                : window.transactions.filter(t => t.quarter === selectedQuarter);

            const incomeTransactions = filteredTransactions.filter(t => t.type === 'income');
            const expenseTransactions = filteredTransactions.filter(t => t.type === 'expense');

            // Huidige rapporten
            // 1. Meest verkochte producten
            const productSales = {};
            incomeTransactions.filter(t => t.category === 'sales' && t.productName).forEach(t => {
                productSales[t.productName] = (productSales[t.productName] || 0) + (parseFloat(t.amount) || 0); // Safe parsing
            });
            renderReport('mostSoldProducts', 'Meest Verkochte Producten', productSales, 'amount', true);

            // 2. Meest geboekte behandelingen
            const treatmentBookings = {};
            incomeTransactions.filter(t => t.category === 'treatments' && t.subcategory).forEach(t => {
                treatmentBookings[t.subcategory] = (treatmentBookings[t.subcategory] || 0) + (parseFloat(t.amount) || 0); // Safe parsing
            });
            renderReport('mostBookedTreatments', 'Meest Geboekte Behandelingen', treatmentBookings, 'amount', true);

            // 3. Beste klanten (op basis van totale besteding)
            const customerSpending = {};
            incomeTransactions.filter(t => t.category === 'treatments' && t.customerName).forEach(t => {
                customerSpending[t.customerName] = (customerSpending[t.customerName] || 0) + (parseFloat(t.amount) || 0); // Safe parsing
            });
            renderReport('bestCustomers', 'Beste Klanten', customerSpending, 'amount', true);

            // 4. Hoogste daginkomsten
            const dailyIncome = {};
            incomeTransactions.forEach(t => {
                const date = new Date(t.timestamp);
                const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                dailyIncome[dateString] = (dailyIncome[dateString] || 0) + (parseFloat(t.amount) || 0); // Safe parsing
            });
            // Sort by date for proper display
            const sortedDailyIncome = Object.entries(dailyIncome)
                                        .sort(([dateA], [dateB]) => new Date(dateA).getTime() - new Date(dateB).getTime())
                                        .map(([date, amount]) => ({ key: new Date(date).toLocaleDateString('nl-NL'), value: amount }));
            renderCustomReport('highestDailyIncome', 'Dagelijkse Inkomsten', sortedDailyIncome.map(item => ({ key: item.key, value: `€ ${item.value.toFixed(2)}` })));


            // 5. Hoogste maandinkomsten
            const monthlyIncome = {};
            incomeTransactions.forEach(t => {
                const date = new Date(t.timestamp);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyIncome[monthYear] = (monthlyIncome[monthYear] || 0) + (parseFloat(t.amount) || 0); // Safe parsing
            });
            // Sort by monthYear for proper display
            const sortedMonthlyIncome = Object.entries(monthlyIncome)
                                        .sort(([monthYearA], [monthYearB]) => monthYearA.localeCompare(monthYearB))
                                        .map(([monthYear, amount]) => ({ key: new Date(monthYear + '-01').toLocaleString('nl-NL', { month: 'long', year: 'numeric' }), value: amount }));
            renderCustomReport('highestMonthlyIncome', 'Maandelijkse Inkomsten', sortedMonthlyIncome.map(item => ({ key: item.key, value: `€ ${item.value.toFixed(2)}` })));


            // NIEUWE RAPPORTEN

            // 1. Uitgaven per Categorie (met percentages)
            const expensesByCategory = {};
            let totalExpensesForPercentage = 0;
            expenseTransactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0; // Safe parsing
                expensesByCategory[t.subcategory] = (expensesByCategory[t.subcategory] || 0) + amount;
                totalExpensesForPercentage += amount;
            });

            const expensesWithPercentages = Object.entries(expensesByCategory).map(([category, amount]) => {
                const percentage = totalExpensesForPercentage > 0 ? (amount / totalExpensesForPercentage * 100).toFixed(2) : 0;
                return { key: category, value: `${amount.toFixed(2)} (€) (${percentage}%)` };
            }).sort((a, b) => parseFloat(b.value.split(' ')[0]) - parseFloat(a.value.split(' ')[0])); // Sort by amount for consistency

            renderCustomReport('expensesByCategory', 'Uitgaven per Categorie', expensesWithPercentages);

            // 2. Inkomsten per Betalingsmethode
            const incomeByPaymentMethod = {};
            incomeTransactions.forEach(t => {
                incomeByPaymentMethod[t.paymentMethod] = (incomeByPaymentMethod[t.paymentMethod] || 0) + (parseFloat(t.amount) || 0); // Safe parsing
            });
            renderReport('incomeByPaymentMethod', 'Inkomsten per Betalingsmethode', incomeByPaymentMethod, 'amount', true);

            // 3. Trendanalyse (Maandelijks Overzicht)
            const monthlyTrends = {}; // { 'YYYY-MM': { income: X, expenses: Y, profit: Z } }
            filteredTransactions.forEach(t => {
                const date = new Date(t.timestamp);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0'); // MM
                const monthKey = `${year}-${month}`;
                const amount = parseFloat(t.amount) || 0; // Safe parsing

                if (!monthlyTrends[monthKey]) {
                    monthlyTrends[monthKey] = { income: 0, expenses: 0, profit: 0, recoverableVat: 0 };
                }

                if (t.type === 'income') {
                    // Ook hier de filter toepassen voor de trendanalyse
                    if (t.paymentMethod !== 'Cadeaubon' && t.paymentMethod !== 'Abonnement') {
                        monthlyTrends[monthKey].income += amount;
                    }
                } else if (t.type === 'expense') {
                    monthlyTrends[monthKey].expenses += amount;
                    if (RECOVERABLE_VAT_EXPENSE_CATEGORIES.includes(t.subcategory)) {
                        monthlyTrends[monthKey].recoverableVat += amount * VAT_RATE;
                    }
                }
            });

            const monthlyTrendList = Object.entries(monthlyTrends).map(([monthKey, data]) => {
                const [year, month] = monthKey.split('-');
                const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('nl-NL', { month: 'long' });
                
                const monthlyIncomeAmount = data.income;
                const monthlyExpensesAmount = data.expenses;
                const monthlyVatOnIncome = monthlyIncomeAmount * VAT_RATE;
                const monthlyProfit = monthlyIncomeAmount - monthlyExpensesAmount - monthlyVatOnIncome + data.recoverableVat;

                return {
                    key: `${monthName} ${year}`,
                    value: `Ink: €${monthlyIncomeAmount.toFixed(2)}, Uit: €${monthlyExpensesAmount.toFixed(2)}, Winst: €${monthlyProfit.toFixed(2)}`
                };
            }).sort((a, b) => {
                // Sort by monthKey (YYYY-MM) to ensure chronological order
                const monthYearA = a.key.split(' ')[1] + '-' + (new Date(Date.parse(a.key.split(' ')[0] + ' 1, 2000')).getMonth() + 1).toString().padStart(2, '0');
                const monthYearB = b.key.split(' ')[1] + '-' + (new Date(Date.parse(b.key.split(' ')[0] + ' 1, 2000')).getMonth() + 1).toString().padStart(2, '0');
                return monthYearA.localeCompare(monthYearB);
            });

            renderCustomReport('monthlyTrends', 'Maandelijkse Trends', monthlyTrendList);


            // 4. BTW-overzicht (Gedetailleerder)
            let totalIncomeForVAT = 0;
            let totalExpensesForRecoverableVAT = 0;
            filteredTransactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0; // Safe parsing
                if (t.type === 'income') {
                    // Ook hier de filter toepassen voor BTW-berekening
                    if (t.paymentMethod !== 'Cadeaubon' && t.paymentMethod !== 'Abonnement') {
                        totalIncomeForVAT += amount;
                    }
                } else if (t.type === 'expense' && RECOVERABLE_VAT_EXPENSE_CATEGORIES.includes(t.subcategory)) {
                    totalExpensesForRecoverableVAT += amount;
                }
            });

            let vatOnIncome = totalIncomeForVAT * VAT_RATE;
            let recoverableVat = totalExpensesForRecoverableVAT * VAT_RATE;
            let netVat = vatOnIncome - recoverableVat;

            const vatReportData = [
                { key: 'BTW over Inkomsten', value: vatOnIncome.toFixed(2) },
                { key: 'Terug te vorderen BTW op Uitgaven', value: recoverableVat.toFixed(2) },
                { key: 'Netto BTW (te betalen/ontvangen)', value: netVat.toFixed(2) }
            ];
            renderCustomReport('vatOverview', 'BTW Overzicht', vatReportData.map(item => ({ key: item.key, value: `€ ${item.value}` })));

            // 5. Transacties per Medewerker
            const transactionsByPerson = {};
            filteredTransactions.forEach(t => {
                const personName = t.person || 'Onbekend';
                transactionsByPerson[personName] = (transactionsByPerson[personName] || 0) + 1; // Count transactions
            });
            renderReport('transactionsByPerson', 'Transacties per Medewerker (aantal)', transactionsByPerson, 'count', true);
        }

        /**
         * Rendert een algemeen rapport in een lijst.
         * @param {string} elementId - De ID van het HTML-element waar het rapport moet worden weergegeven.
         * @param {string} title - De titel van het rapport.
         * @param {object} data - Het object met de rapportdata (key: value).
         * @param {string} valueType - Het type waarde ('count' of 'amount').
         * @param {boolean} sortDescending - Of de lijst aflopend moet worden gesorteerd.
         */
        function renderReport(elementId, title, data, valueType, sortDescending = true) {
            const reportContainer = document.getElementById(elementId);
            if (!reportContainer) return;

            let items = Object.entries(data).map(([key, value]) => ({ key, value }));

            if (sortDescending) {
                items.sort((a, b) => b.value - a.value);
            } else {
                items.sort((a, b) => a.value - b.value);
            }

            let html = `<h3>${title}</h3><ul>`;
            if (items.length === 0) {
                html += `<li>Geen data beschikbaar.</li>`;
            } else {
                items.forEach(item => {
                    const formattedValue = valueType === 'amount' ? `€ ${item.value.toFixed(2)}` : item.value;
                    html += `<li>${item.key}: ${formattedValue}</li>`;
                });
            }
            html += `</ul>`;
            reportContainer.innerHTML = html;
        }

        /**
         * Rendert een custom rapport met reeds geformatteerde waarden.
         * @param {string} elementId - De ID van het HTML-element waar het rapport moet worden weergegeven.
         * @param {string} title - De titel van het rapport.
         * @param {Array<Object>} data - Een array van objecten { key: string, value: string }.
         */
        function renderCustomReport(elementId, title, data) {
            const reportContainer = document.getElementById(elementId);
            if (!reportContainer) return;

            let html = `<h3>${title}</h3><ul>`;
            if (data.length === 0) {
                html += `<li>Geen data beschikbaar.</li>`;
            } else {
                data.forEach(item => {
                    html += `<li>${item.key}: ${item.value}</li>`;
                });
            }
            html += `</ul>`;
            reportContainer.innerHTML = html;
        }

        /**
         * Toont een custom bevestigingsdialoog.
         * @param {string} message - Het bericht om te tonen.
         * @returns {Promise<boolean>} Resolves met true als bevestigd, false als geannuleerd.
         */
        function showCustomConfirm(message) {
            return new Promise(resolve => {
                const confirmBox = document.createElement('div');
                confirmBox.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    text-align: center;
                    max-width: 300px;
                    border: 1px solid #ccc;
                `;
                confirmBox.innerHTML = `
                    <p>${message}</p>
                    <div style="margin-top: 15px;">
                        <button id="confirmYes" style="margin-right: 10px; padding: 8px 15px; background-color: #48bb78; color: white; border: none; border-radius: 5px; cursor: pointer;">Ja</button>
                        <button id="confirmNo" style="padding: 8px 15px; background-color: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer;">Nee</button>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                document.getElementById('confirmYes').onclick = () => {
                    document.body.removeChild(confirmBox);
                    resolve(true);
                };
                document.getElementById('confirmNo').onclick = () => {
                    document.body.removeChild(confirmBox);
                    resolve(false);
                };
            });
        }

        // Functie om af te melden
        window.logoutUser = function() {
            signOut(window.auth).then(() => {
                console.log("Succesvol afgemeld.");
                window.location.href = 'auth.html'; // Terug naar inlogpagina
            }).catch((error) => {
                console.error("Fout bij afmelden:", error);
                // Hier zou je een custom melding kunnen tonen in plaats van alert
                showCustomConfirm("Fout bij afmelden. Probeer opnieuw.");
            });
        }

        // Initialiseer de app bij het laden van de pagina
        window.onload = function() {
            console.log("Window onload geactiveerd."); // Debug log
            window.initFirebase();
            window.initAudio();

            // Voeg event listeners toe
            document.getElementById('summaryQuarterSelect').addEventListener('change', displaySummary);
            document.getElementById('backToMainBtn').addEventListener('click', navigateToHome);
            document.getElementById('logoutBtn').addEventListener('click', logoutUser); // Event listener voor afmeldknop
        };
    </script>
    <style>
        body {
            font-family: 'Calibri', sans-serif;
            background-color: #e0f2f7;
            color: #4a5568;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1200px; /* Bredere container voor overzichtstabel */
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        .header-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-container .logo-small {
            max-width: 80px;
            height: auto;
            margin-right: 20px;
            border-radius: 8px;
        }
        h1 {
            color: #2c5282;
            font-size: 2.2rem;
            flex-grow: 1;
            text-align: center;
        }
        h2 {
            font-size: 1.8rem;
            margin-top: 30px;
            text-align: center;
            color: #2c5282;
        }
        h3 {
            font-size: 1.4rem;
            color: #2d3748;
            margin-top: 25px;
            margin-bottom: 15px;
            text-align: left;
            border-bottom: 2px solid #cbd5e0;
            padding-bottom: 5px;
        }
        .summary-section, .reports-section, .transaction-list-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background-color: #f7fafc;
            text-align: left;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-item {
            background-color: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .summary-item strong {
            display: block;
            font-size: 1.1rem;
            color: #2c5282;
            margin-bottom: 5px;
        }
        .summary-item span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3182ce;
        }
        .summary-item.profit span {
            color: #2f855a; /* Green for profit */
        }
        .summary-item.expense span {
            color: #c53030; /* Red for expenses */
        }
        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #a0aec0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            background-color: #63b3ed;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        button:hover {
            background-color: #4299e1;
            transform: translateY(-2px);
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .user-id-display {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #718096;
        }
        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 15px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Transaction List Table Styles */
        .transaction-table-container {
            overflow-x: auto; /* Zorgt voor scrollen op kleine schermen */
            margin-top: 20px;
        }
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Minimale breedte voor de tabel */
        }
        .transaction-table th, .transaction-table td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: left;
        }
        .transaction-table th {
            background-color: #edf2f7;
            font-weight: bold;
            color: #2d3748;
        }
        .transaction-table .edit-btn, .transaction-table .delete-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 5px;
            margin-right: 5px;
            margin-top: 0; /* Override default button margin-top */
            box-shadow: none; /* Remove button shadow for table buttons */
        }
        .transaction-table .edit-btn {
            background-color: #48bb78; /* Green for edit */
        }
        .transaction-table .edit-btn:hover {
            background-color: #38a169;
        }
        .transaction-table .delete-btn {
            background-color: #ef4444; /* Red for delete */
        }
        .transaction-table .delete-btn:hover {
            background-color: #dc2626;
        }

        /* Responsive table for mobile */
        @media screen and (max-width: 768px) {
            .transaction-table thead {
                display: none; /* Verberg thead op kleine schermen */
            }
            .transaction-table, .transaction-table tbody, .transaction-table tr, .transaction-table td {
                display: block; /* Maak alles block elementen */
                width: 100%;
            }
            .transaction-table tr {
                margin-bottom: 15px;
                border: 1px solid #e2e8f0;
                border-radius: 10px;
                background-color: #f7fafc;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            .transaction-table td {
                text-align: right;
                padding-left: 50%; /* Ruimte voor data-label */
                position: relative;
            }
            .transaction-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: calc(50% - 20px);
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #2d3748;
            }
            .transaction-table td:last-child {
                text-align: center; /* Centreer actie knoppen */
            }
        }

        /* Report List Styles */
        .reports-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .reports-section li {
            background-color: #edf2f7;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            color: #2d3748;
        }
        .reports-section li:last-child {
            margin-bottom: 0;
        }
        .reports-section li span {
            font-weight: bold;
            color: #3182ce;
        }
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Override button styles for the "Afmelden" button */
        button#logoutBtn {
            background-color: #ef4444; /* Red for logout */
        }
        button#logoutBtn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <img src="Black logo - no background.png" alt="Bedrijfslogo" class="logo-small" onerror="this.onerror=null;this.src='https://placehold.co/80x80/000/fff?text=Logo+Niet+Gevonden';">
            <h1>Financiële Tracker - Overzicht</h1>
        </div>

        <div class="user-id-display">
            Je gebruikers-ID: <span id="currentUserId">Laden...</span>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
        </div>

        <div class="summary-section">
            <h2 class="text-xl font-semibold mb-4">Financiële Samenvatting <span id="currentQuarterDisplay"></span></h2>
            <div class="input-group">
                <label for="summaryQuarterSelect">Selecteer Kwartaal:</label>
                <select id="summaryQuarterSelect"></select>
            </div>
            <div class="summary-grid">
                <div class="summary-item">
                    <strong>Totaal Behandelingen</strong>
                    <span id="totalTreatments">€ 0.00</span>
                </div>
                <div class="summary-item">
                    <strong>Totaal Verkoop</strong>
                    <span id="totalSales">€ 0.00</span>
                </div>
                <div class="summary-item">
                    <strong>Totale Inkomsten</strong>
                    <span id="totalIncome">€ 0.00</span>
                </div>
                <div class="summary-item expense">
                    <strong>Totale Uitgaven</strong>
                    <span id="totalExpenses">€ 0.00</span>
                </div>
                <div class="summary-item">
                    <strong>Terug te vorderen BTW op Uitgaven</strong>
                    <span id="totalRecoverableVATOnExpenses">€ 0.00</span>
                </div>
                <div class="summary-item">
                    <strong>Totaal Af te dragen BTW</strong>
                    <span id="totalVAT">€ 0.00</span>
                </div>
                <div class="summary-item profit">
                    <strong>Totale Winst</strong>
                    <span id="totalProfit">€ 0.00</span>
                </div>
            </div>
        </div>

        <div class="reports-section">
            <h2 class="text-xl font-semibold mb-4">Rapporten</h2>
            <div class="reports-grid">
                <div id="mostSoldProducts"></div>
                <div id="mostBookedTreatments"></div>
                <div id="bestCustomers"></div>
                <div id="highestDailyIncome"></div>
                <div id="highestMonthlyIncome"></div>
                <div id="expensesByCategory"></div>
                <div id="incomeByPaymentMethod"></div>
                <div id="monthlyTrends"></div>
                <div id="vatOverview"></div>
                <div id="transactionsByPerson"></div>
            </div>
        </div>

        <div class="transaction-list-section">
            <h2 class="text-xl font-semibold mb-4">Alle Transacties</h2>
            <div class="transaction-table-container">
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>Kwartaal</th>
                            <th>Type</th>
                            <th>Categorie</th>
                            <th>Subcategorie</th>
                            <th>Betaling</th>
                            <th>Bedrag (€)</th>
                            <th>Klantnaam</th>
                            <th>Productnaam</th>
                            <th>Factuurdatum</th>
                            <th>Opmerkingen</th>
                            <th>Datum Ingave</th>
                            <th>Ingevoerd Door</th>
                            <th>Acties</th>
                        </tr>
                    </thead>
                    <tbody id="transactionListBody">
                        <!-- Transacties worden hier geladen -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="button-group">
            <button id="backToMainBtn">Terug naar Start</button>
            <button id="logoutBtn">Afmelden</button>
        </div>
    </div>
</body>
</html>
