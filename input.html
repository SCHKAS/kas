<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financiële Tracker - Invoer</title>
    <base href="/kas/"> <!-- Belangrijke toevoeging voor juiste paden op GitHub Pages -->
    <link rel="manifest" href="manifest.json"> <!-- Link naar het PWA manifest bestand -->
    <script>
        // Registreer de Service Worker voor PWA functionaliteit
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js voor geluidseffecten -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase SDK imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.transactions = []; // Store transactions globally
        window.isLoading = false; // Nieuwe globale variabele voor laadstatus

        // Make Firestore functions globally available
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.getDoc = getDoc; // Make getDoc globally available
        window.writeBatch = writeBatch; // Make writeBatch globally available

        // Tone.js synth voor notificatiegeluid
        let synth;
        window.initAudio = async () => {
            if (!synth) {
                // Initialiseer Tone.js context en synth
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                console.log("Audio context geïnitialiseerd.");
            }
        };

        window.playPingSound = () => {
            if (synth) {
                synth.triggerAttackRelease("C5", "8n"); // Speel een korte C5 noot
            } else {
                console.warn("Audio synth is nog niet geïnitialiseerd.");
            }
        };

        // Initialize Firebase and set up authentication
        window.initFirebase = async () => {
            console.log("initFirebase gestart."); // Debug log
            // Updated app ID for this version to ensure data separation
            const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'finance-tracker-bulk-app';
            window.APP_ID = APP_ID; // Make it globally accessible for Firestore paths
            console.log(`App ID ingesteld: ${window.APP_ID}`); // Debug log

            let firebaseConfig = {};

            // De Firebase configuratie is nu direct hieronder geplakt.
            // Deze is afkomstig van jouw Firebase project: schkas-66d27
            firebaseConfig = {
              apiKey: "AIzaSyCORzv-FVt-7ZUxMBUsmaTl9ZAGcgZk8io",
              authDomain: "schkas-66d27.firebaseapp.com",
              projectId: "schkas-66d27",
              storageBucket: "schkas-66d27.firebasestorage.app",
              messagingSenderId: "987453212703",
              appId: "1:987453212703:web:dcee394027367b74df2d2a",
              measurementId: "G-9M60TQGKJZ"
            };

            if (Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase configuratie is onvolledig of nog steeds een placeholder. Persistente opslag zal niet werken. Werk firebaseConfig bij met je echte Firebase projectgegevens.");
            }

            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            console.log("Firebase app, db, auth geïnitialiseerd."); // Debug log

            // Listen for authentication state changes
            onAuthStateChanged(window.auth, async (user) => {
                console.log("onAuthStateChanged callback geactiveerd."); // Debug log
                if (user) {
                    window.userId = user.uid;
                    console.log("Gebruiker geauthenticeerd:", window.userId);
                    window.isAuthReady = true;
                } else {
                    console.log("Geen gebruiker gevonden, doorsturen naar auth.html."); // Debug log
                    window.location.href = 'auth.html'; // Redirect to login page
                }
                console.log(`isAuthReady ingesteld op ${window.isAuthReady}. userId: ${window.userId}`); // Debug log
            });
        };

        // BTW-percentage (aanpasbaar)
        const VAT_RATE = 0.21; // 21%

        // Categorieën voor inkomsten en uitgaven
        const INCOME_CATEGORIES = {
            'Behandelingen': [
                'Suikerontharing', 'Laserontharing', 'Nagels', 'Manicure', 'Pedicure',
                'Gelaatsverzorging', 'Massage', 'Wimpers/brows', 'Spraytan', 'Make up',
                'LPG', 'Celestetic', 'Andere'
            ],
            'Verkoop': [
                'Voorschotten', 'Biologique Recherche', 'I AM KLEAN', 'LPG',
                'Atelier Rebul', 'Lash Extend', 'My Lamination', 'Pandhys', 'OPI',
                'Abonnementen', 'Cadeaubon', 'Footlogix', 'Celestetic', 'Andere'
            ]
        };

        const EXPENSE_CATEGORIES = {
            'Lonen': ['Lonen'],
            'Derden': ['Derden'],
            'Huur': ['Huur'],
            'Producten': ['Producten'],
            'Nutsvoorziening': ['Nutsvoorziening'],
            'Boekhouder': ['Boekhouder'],
            'Verzekeringen': ['Verzekeringen'],
            'Marketing': ['Marketing'],
            'Software': ['Software'],
            'Leasing': ['Leasing'],
            'Afbetaling': ['Afbetaling'],
            'Loonkost': ['Loonkost'],
            'Sponsoring': ['Sponsoring'],
            'BTW': ['BTW'],
            'Andere': ['Andere']
        };

        // Categorieën waarop BTW teruggevorderd kan worden voor uitgaven
        const RECOVERABLE_VAT_EXPENSE_CATEGORIES = [
            "Producten",
            "Nutsvoorziening",
            "Boekhouder",
            "Verzekeringen",
            "Marketing",
            "Software",
            "Verbruiksartikelen" // Assuming this is still relevant, though not explicitly in new list
        ];

        // Beperkte betalingsmethoden
        const PAYMENT_METHODS = ['Cash', 'Payconiq/BC', 'Cadeaubon', 'Abonnement'];

        // Opties voor 'Ingevoerd Door'
        const PERSON_OPTIONS = ['Marlien', 'Kimberly', 'Yasmine', 'Jade'];

        // Functies voor het beheren van de UI
        /**
         * Update de categorie-opties in een select-element.
         * @param {HTMLSelectElement} typeSelect - Het 'type' select-element (inkomsten/uitgaven).
         * @param {HTMLSelectElement} categorySelect - Het 'categorie' select-element.
         */
        window.updateCategoriesForForm = function(typeSelect, categorySelect) {
            const type = typeSelect.value;
            categorySelect.innerHTML = '<option value="">Selecteer Categorie</option>';

            let categories = {};
            if (type === 'income') {
                categories = INCOME_CATEGORIES;
            } else if (type === 'expense') {
                categories = EXPENSE_CATEGORIES;
            }

            for (const cat in categories) {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            }
        }

        /**
         * Update de subcategorie-opties in een select-element en beheert de zichtbaarheid van afhankelijke velden.
         * @param {HTMLSelectElement} typeSelect - Het 'type' select-element.
         * @param {HTMLSelectElement} categorySelect - Het 'categorie' select-element.
         * @param {HTMLSelectElement} subcategorySelect - Het 'subcategorie' select-element.
         * @param {HTMLElement} paymentMethodGroup - De groep voor betalingsmethode.
         * @param {HTMLElement} customerNameGroup - De groep voor klantnaam.
         * @param {HTMLElement} productNameGroup - De groep voor productnaam.
         * @param {HTMLElement} invoiceDateGroup - De groep voor factuurdatum.
         */
        window.updateSubcategoriesForForm = function(typeSelect, categorySelect, subcategorySelect, paymentMethodGroup, customerNameGroup, productNameGroup, invoiceDateGroup) {
            const type = typeSelect.value;
            const category = categorySelect.value;

            subcategorySelect.innerHTML = '<option value="">Selecteer Subcategorie</option>';

            // Reset display states for conditional fields
            paymentMethodGroup.style.display = 'none';
            customerNameGroup.style.display = 'none';
            productNameGroup.style.display = 'none';
            invoiceDateGroup.style.display = 'none';

            if (type === 'income') {
                if (category && INCOME_CATEGORIES[category]) {
                    INCOME_CATEGORIES[category].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subcategorySelect.appendChild(option);
                    });
                }
                paymentMethodGroup.style.display = 'block';
                customerNameGroup.style.display = 'block';

                // Specifieke logica voor 'Productnaam' bij 'Behandelingen'
                if (category === 'Behandelingen') {
                    productNameGroup.style.display = 'none'; // Verberg productnaam bij behandelingen
                } else {
                    productNameGroup.style.display = 'block'; // Toon productnaam voor andere inkomsten
                }
            } else if (type === 'expense') {
                if (category && EXPENSE_CATEGORIES[category]) {
                    EXPENSE_CATEGORIES[category].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subcategorySelect.appendChild(option);
                    });
                }
                invoiceDateGroup.style.display = 'block';
            }
        }

        /**
         * Toont/verbergt de laadindicator.
         * @param {boolean} show - True om te tonen, false om te verbergen.
         */
        function showLoadingIndicator(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = show ? 'flex' : 'none';
            }
            window.isLoading = show;
            console.log(`Laadindicator: ${show ? 'getoond' : 'verborgen'}`); // Debug log
        }

        /**
         * Haalt de formuliergegevens op en valideert deze voor een specifiek transactieformulier.
         * @param {HTMLElement} formElement - Het root-element van het transactieformulier.
         * @returns {object} Een object met isValid (boolean) en data (object) of message (string).
         */
        function getFormData(formElement) {
            const typeEl = formElement.querySelector('.transaction-type-select');
            const categoryEl = formElement.querySelector('.transaction-category-select');
            const subcategoryEl = formElement.querySelector('.transaction-subcategory-select');
            const amountEl = formElement.querySelector('.transaction-amount-input');
            const paymentMethodEl = formElement.querySelector('.transaction-payment-method-select');
            const customerNameEl = formElement.querySelector('.transaction-customer-name-input');
            const productNameEl = formElement.querySelector('.transaction-product-name-input');
            const invoiceDateEl = formElement.querySelector('.transaction-invoice-date-input');
            const remarksEl = formElement.querySelector('.transaction-remarks-input');
            const personEl = formElement.querySelector('.transaction-person-select'); // Aangepast naar select
            const quarterEl = formElement.querySelector('.transaction-quarter-input');

            const type = typeEl.value;
            const category = categoryEl.value;
            const subcategory = subcategoryEl.value;
            const amount = parseFloat(amountEl.value);
            const paymentMethod = paymentMethodEl.value;
            const customerName = customerNameEl.value;
            const productName = productNameEl.value;
            const invoiceDate = invoiceDateEl.value;
            const remarks = remarksEl.value;
            const person = personEl.value;
            const quarter = quarterEl.value;
            const timestamp = new Date().toISOString(); // Altijd de huidige tijd voor sortering

            // Basisvalidatie
            if (!type || !category || !subcategory || isNaN(amount) || amount <= 0 || !person || !quarter) {
                return { isValid: false, message: 'Vul alstublieft alle verplichte velden in (Type, Categorie, Subcategorie, Bedrag, Persoon, Kwartaal) en zorg voor een positief bedrag.' };
            }

            if (type === 'income') {
                if (!paymentMethod || !customerName) {
                    return { isValid: false, message: 'Voor inkomsten zijn Betalingsmethode en Klantnaam verplicht.' };
                }
                // Productnaam is alleen verplicht als het geen 'Behandelingen' is
                if (category !== 'Behandelingen' && !productName) {
                    return { isValid: false, message: 'Voor inkomsten (niet-behandelingen) is Productnaam verplicht.' };
                }
            }

            if (type === 'expense' && !invoiceDate) {
                return { isValid: false, message: 'Voor uitgaven is de Factuurdatum verplicht.' };
            }

            return {
                isValid: true,
                data: {
                    type,
                    category,
                    subcategory,
                    amount,
                    paymentMethod: type === 'income' ? paymentMethod : '', // Alleen voor inkomsten
                    customerName: type === 'income' ? customerName : '', // Alleen voor inkomsten
                    productName: (type === 'income' && category !== 'Behandelingen') ? productName : '', // Alleen voor inkomsten (niet behandelingen)
                    invoiceDate: type === 'expense' ? invoiceDate : '', // Alleen voor uitgaven
                    remarks,
                    person,
                    quarter,
                    timestamp
                }
            };
        }

        /**
         * Maakt alle dynamische formulieren leeg en reset de UI naar de initiële staat.
         */
        window.clearForm = function() {
            const dynamicTransactionFormsContainer = document.getElementById('dynamicTransactionFormsContainer');
            dynamicTransactionFormsContainer.innerHTML = ''; // Clear all existing forms
            transactionFormCounter = 0; // Reset counter for new forms
            addTransactionForm(); // Add one default empty form
        }

        let transactionFormCounter = 0; // Counter for unique IDs of dynamic transaction forms

        /**
         * Voegt een nieuw leeg transactieformulier toe aan de dynamische lijst.
         * @param {object} [initialData={}] - Optionele initiële data om het formulier mee te vullen.
         */
        window.addTransactionForm = function(initialData = {}) {
            transactionFormCounter++;
            const container = document.getElementById('dynamicTransactionFormsContainer');
            const formId = `transactionForm_${transactionFormCounter}`;
            const newFormDiv = document.createElement('div');
            newFormDiv.classList.add('transaction-form-item', 'bg-blue-50', 'p-4', 'rounded-lg', 'shadow-sm', 'mb-4');
            newFormDiv.id = formId;

            let paymentMethodOptions = PAYMENT_METHODS.map(method => `<option value="${method}">${method}</option>`).join('');
            let personOptions = PERSON_OPTIONS.map(person => `<option value="${person}">${person}</option>`).join('');

            newFormDiv.innerHTML = `
                <h3 class="text-lg font-semibold mb-3 text-blue-700">Transactie #${transactionFormCounter}</h3>
                <div class="form-group">
                    <label for="type_${formId}">Type Transactie:</label>
                    <select id="type_${formId}" class="transaction-type-select w-full p-2 border rounded-md" required>
                        <option value="">Selecteer Type</option>
                        <option value="income">Inkomst</option>
                        <option value="expense">Uitgave</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="category_${formId}">Categorie:</label>
                    <select id="category_${formId}" class="transaction-category-select w-full p-2 border rounded-md" required>
                        <option value="">Selecteer Categorie</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subcategory_${formId}">Subcategorie:</label>
                    <select id="subcategory_${formId}" class="transaction-subcategory-select w-full p-2 border rounded-md" required>
                        <option value="">Selecteer Subcategorie</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount_${formId}">Bedrag (€):</label>
                    <input type="number" id="amount_${formId}" class="transaction-amount-input w-full p-2 border rounded-md" step="0.01" placeholder="0.00" required>
                </div>

                <div class="form-group conditional-field" id="paymentMethodGroup_${formId}" style="display: none;">
                    <label for="paymentMethod_${formId}">Betalingsmethode:</label>
                    <select id="paymentMethod_${formId}" class="transaction-payment-method-select w-full p-2 border rounded-md">
                        <option value="">Selecteer Methode</option>
                        ${paymentMethodOptions}
                    </select>
                </div>
                <div class="form-group conditional-field" id="customerNameGroup_${formId}" style="display: none;">
                    <label for="customerName_${formId}">Klantnaam:</label>
                    <input type="text" id="customerName_${formId}" class="transaction-customer-name-input w-full p-2 border rounded-md" placeholder="Naam van de klant">
                </div>
                <div class="form-group conditional-field" id="productNameGroup_${formId}" style="display: none;">
                    <label for="productName_${formId}">Productnaam:</label>
                    <input type="text" id="productName_${formId}" class="transaction-product-name-input w-full p-2 border rounded-md" placeholder="Naam van het product">
                </div>
                <div class="form-group conditional-field" id="invoiceDateGroup_${formId}" style="display: none;">
                    <label for="invoiceDate_${formId}">Factuurdatum:</label>
                    <input type="date" id="invoiceDate_${formId}" class="transaction-invoice-date-input w-full p-2 border rounded-md">
                </div>

                <div class="form-group">
                    <label for="remarks_${formId}">Opmerkingen:</label>
                    <textarea id="remarks_${formId}" class="transaction-remarks-input w-full p-2 border rounded-md" placeholder="Eventuele opmerkingen"></textarea>
                </div>
                <div class="form-group">
                    <label for="person_${formId}">Ingevoerd Door (Naam):</label>
                    <select id="person_${formId}" class="transaction-person-select w-full p-2 border rounded-md" required>
                        <option value="">Selecteer Persoon</option>
                        ${personOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label for="quarter_${formId}">Kwartaal (bijv. 2023 Q4):</label>
                    <input type="text" id="quarter_${formId}" class="transaction-quarter-input w-full p-2 border rounded-md" placeholder="JJJJ QX" required>
                </div>
                <button type="button" class="remove-transaction-form-btn bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded-md mt-2">Verwijderen</button>
            `;
            container.appendChild(newFormDiv);

            // Populate with initial data if provided
            if (Object.keys(initialData).length > 0) {
                newFormDiv.querySelector(`#type_${formId}`).value = initialData.type || '';
                window.updateCategoriesForForm(
                    newFormDiv.querySelector(`#type_${formId}`),
                    newFormDiv.querySelector(`#category_${formId}`)
                );
                newFormDiv.querySelector(`#category_${formId}`).value = initialData.category || '';
                window.updateSubcategoriesForForm(
                    newFormDiv.querySelector(`#type_${formId}`),
                    newFormDiv.querySelector(`#category_${formId}`),
                    newFormDiv.querySelector(`#subcategory_${formId}`),
                    newFormDiv.querySelector(`#paymentMethodGroup_${formId}`),
                    newFormDiv.querySelector(`#customerNameGroup_${formId}`),
                    newFormDiv.querySelector(`#productNameGroup_${formId}`),
                    newFormDiv.querySelector(`#invoiceDateGroup_${formId}`)
                );
                newFormDiv.querySelector(`#subcategory_${formId}`).value = initialData.subcategory || '';
                newFormDiv.querySelector(`#amount_${formId}`).value = initialData.amount || '';
                newFormDiv.querySelector(`#paymentMethod_${formId}`).value = initialData.paymentMethod || '';
                newFormDiv.querySelector(`#customerName_${formId}`).value = initialData.customerName || '';
                newFormDiv.querySelector(`#productName_${formId}`).value = initialData.productName || '';
                newFormDiv.querySelector(`#invoiceDate_${formId}`).value = initialData.invoiceDate || '';
                newFormDiv.querySelector(`#remarks_${formId}`).value = initialData.remarks || '';
                newFormDiv.querySelector(`#person_${formId}`).value = initialData.person || '';
                newFormDiv.querySelector(`#quarter_${formId}`).value = initialData.quarter || getDefaultQuarter();
            } else {
                // Set default quarter for new empty forms
                newFormDiv.querySelector(`#quarter_${formId}`).value = getDefaultQuarter();
            }


            // Attach event listeners for the new form
            const typeSelect = newFormDiv.querySelector(`#type_${formId}`);
            const categorySelect = newFormDiv.querySelector(`#category_${formId}`);
            const subcategorySelect = newFormDiv.querySelector(`#subcategory_${formId}`);
            const paymentMethodGroup = newFormDiv.querySelector(`#paymentMethodGroup_${formId}`);
            const customerNameGroup = newFormDiv.querySelector(`#customerNameGroup_${formId}`);
            const productNameGroup = newFormDiv.querySelector(`#productNameGroup_${formId}`);
            const invoiceDateGroup = newFormDiv.querySelector(`#invoiceDateGroup_${formId}`);

            typeSelect.addEventListener('change', () => {
                window.updateCategoriesForForm(typeSelect, categorySelect);
                window.updateSubcategoriesForForm(typeSelect, categorySelect, subcategorySelect, paymentMethodGroup, customerNameGroup, productNameGroup, invoiceDateGroup);
            });
            categorySelect.addEventListener('change', () => {
                window.updateSubcategoriesForForm(typeSelect, categorySelect, subcategorySelect, paymentMethodGroup, customerNameGroup, productNameGroup, invoiceDateGroup);
            });

            newFormDiv.querySelector('.remove-transaction-form-btn').addEventListener('click', (event) => {
                removeTransactionForm(event.target.closest('.transaction-form-item'));
            });

            // Initial population for the newly added form
            window.updateCategoriesForForm(typeSelect, categorySelect);
            window.updateSubcategoriesForForm(typeSelect, categorySelect, subcategorySelect, paymentMethodGroup, customerNameGroup, productNameGroup, invoiceDateGroup);
        }

        /**
         * Verwijdert een dynamisch toegevoegd transactieformulier.
         * @param {HTMLElement} formElement - Het formulier-element dat verwijderd moet worden.
         */
        function removeTransactionForm(formElement) {
            if (document.querySelectorAll('.transaction-form-item').length > 1) {
                formElement.remove();
            } else {
                showMessageBox('U moet minstens één transactieformulier hebben.');
            }
        }

        /**
         * Haalt het standaard kwartaal op (bijv. 2023 Q4).
         * @returns {string} Het huidige kwartaal.
         */
        function getDefaultQuarter() {
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            let quarter;
            if (month >= 0 && month <= 2) quarter = `${year} Q1`;
            else if (month >= 3 && month <= 5) quarter = `${year} Q2`;
            else if (month >= 6 && month <= 8) quarter = `${year} Q3`;
            else quarter = `${year} Q4`;
            return quarter;
        }

        /**
         * Slaat alle transacties op die in de dynamische formulieren zijn ingevoerd.
         */
        window.saveAllTransactions = async function() {
            const transactionForms = document.querySelectorAll('.transaction-form-item');
            const transactionsToSave = [];
            const errors = [];

            transactionForms.forEach((formElement, index) => {
                const result = getFormData(formElement); // Pass the form element directly

                if (result.isValid) {
                    transactionsToSave.push({ ...result.data, createdByUserId: window.userId });
                } else {
                    errors.push(`Transactie ${index + 1}: ${result.message}`);
                }
            });

            if (errors.length > 0) {
                showMessageBox('Fouten gevonden in transacties:\n' + errors.join('\n'));
                return;
            }

            if (transactionsToSave.length === 0) {
                showMessageBox('Geen geldige transacties gevonden om op te slaan.');
                return;
            }

            showLoadingIndicator(true);
            try {
                const transactionsCollectionRef = window.collection(window.db, `artifacts/${window.APP_ID}/public/data/transactions`);
                const batch = window.writeBatch(window.db); // Maak een nieuwe batch aan

                for (const transaction of transactionsToSave) {
                    const newDocRef = window.doc(transactionsCollectionRef); // Genereer een nieuwe doc referentie
                    batch.set(newDocRef, transaction); // Voeg de set-operatie toe aan de batch
                }

                await batch.commit(); // Commit de batch

                showMessageBox(`${transactionsToSave.length} transacties succesvol opgeslagen.`);
                window.playPingSound();
                clearForm(); // Leeg alle formulieren na opslaan
            } catch (e) {
                console.error("Fout bij het opslaan van alle transacties:", e);
                showMessageBox('Fout bij het opslaan van alle transacties. Probeer opnieuw.');
            } finally {
                showLoadingIndicator(false);
            }
        }


        // Custom message box function (replaces alert() and confirm())
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
                max-width: 300px;
                border: 1px solid #ccc;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button style="margin-top: 15px; padding: 8px 15px; background-color: #63b3ed; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
            `;
            document.body.appendChild(messageBox);

            messageBox.querySelector('button').onclick = () => {
                document.body.removeChild(messageBox);
            };
        }

        // Functie om af te melden
        window.logoutUser = function() {
            signOut(window.auth).then(() => {
                console.log("Succesvol afgemeld.");
                window.location.href = 'auth.html'; // Terug naar inlogpagina
            }).catch((error) => {
                console.error("Fout bij afmelden:", error);
                showMessageBox("Fout bij afmelden. Probeer opnieuw.");
            });
        }

        // Initialiseer de app bij het laden van de pagina
        window.onload = function() {
            console.log("Window onload geactiveerd."); // Debug log
            window.initFirebase();
            window.initAudio();

            // Event listeners voor de nieuwe bulk functionaliteit
            document.getElementById('addTransactionFormBtn').addEventListener('click', () => addTransactionForm());
            document.getElementById('saveAllTransactionsBtn').addEventListener('click', window.saveAllTransactions);
            document.getElementById('clearFormBtn').addEventListener('click', window.clearForm); // Clear all dynamic forms
            document.getElementById('backToMainBtn').addEventListener('click', () => window.location.href = 'index.html');
            document.getElementById('logoutBtn').addEventListener('click', window.logoutUser);

            // Voeg standaard één leeg transactieformulier toe voor bulk input
            addTransactionForm();
        };
    </script>
    <style>
        body {
            font-family: 'Calibri', sans-serif;
            background-color: #e0f2f7;
            color: #4a5568;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
            text-align: center;
            position: relative; /* Voor de laadindicator */
        }
        h1 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 2.2rem;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #a0aec0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        button {
            background-color: #63b3ed;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        button:hover {
            background-color: #4299e1;
            transform: translateY(-2px);
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap; /* Zorgt ervoor dat knoppen inpakken op kleinere schermen */
        }
        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 15px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .multiple-transactions-section {
            margin-top: 0; /* No top margin needed if it's the only section */
            padding-top: 0; /* No top padding needed */
            border-top: none; /* No border top needed */
        }
        .multiple-transactions-section h2 {
            font-size: 1.5rem;
            color: #2c5282;
            margin-bottom: 15px;
        }
        .transaction-form-item {
            border: 1px solid #cbd5e0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            background-color: #f7fafc;
            position: relative;
        }
        .transaction-form-item h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: left;
        }
        .remove-transaction-form-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0; /* Override default button margin-top */
        }
        .remove-transaction-form-btn:hover {
            background-color: #dc2626;
        }
        /* Overrides for specific buttons */
        button#clearFormBtn {
            background-color: #f6ad55; /* Orange for clear */
        }
        button#clearFormBtn:hover {
            background-color: #ed8936;
        }
        button#addTransactionFormBtn, button#saveAllTransactionsBtn {
            background-color: #805ad5; /* Purple for bulk/add */
        }
        button#addTransactionFormBtn:hover, button#saveAllTransactionsBtn:hover {
            background-color: #6b46c1;
        }
        button#logoutBtn {
            background-color: #ef4444; /* Red for logout */
        }
        button#logoutBtn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Transactie Invoeren</h1>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
        </div>

        <!-- Multiple Transactions Input Section -->
        <div id="multipleTransactionsSection" class="multiple-transactions-section">
            <h2>Meerdere Transacties Invoeren</h2>
            <div id="dynamicTransactionFormsContainer">
                <!-- Dynamische transactieformulieren worden hier toegevoegd -->
            </div>
            <div class="button-group">
                <button id="addTransactionFormBtn">Transactie Toevoegen</button>
                <button id="saveAllTransactionsBtn">Alle Transacties Opslaan</button>
                <button id="clearFormBtn">Formulier Leegmaken</button>
            </div>
        </div>

        <div class="button-group mt-8">
            <button id="backToMainBtn">Terug naar Hoofdpagina</button>
            <button id="logoutBtn">Afmelden</button>
        </div>
    </div>
</body>
</html>
