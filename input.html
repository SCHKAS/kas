<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financiële Tracker - Invoer</title>
    <base href="/kas/"> <!-- Belangrijke toevoeging voor juiste paden op GitHub Pages -->
    <link rel="manifest" href="manifest.json"> <!-- Link naar het PWA manifest bestand -->
    <script>
        // Registreer de Service Worker voor PWA functionaliteit
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js voor geluidseffecten -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase SDK imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.transactions = []; // Store transactions globally for consistency and editing purposes
        window.isLoading = false; // Nieuwe globale variabele voor laadstatus

        // Make Firestore functions globally available
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.orderBy = orderBy;

        // Tone.js synth voor notificatiegeluid
        let synth;
        window.initAudio = async () => {
            if (!synth) {
                // Initialiseer Tone.js context en synth
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                console.log("Audio context geïnitialiseerd.");
            }
        };

        window.playPingSound = () => {
            if (synth) {
                synth.triggerAttackRelease("C5", "8n"); // Speel een korte C5 noot
            } else {
                console.warn("Audio synth is nog niet geïnitialiseerd.");
            }
        };

        // Initialize Firebase and set up authentication
        window.initFirebase = async () => {
            // Updated app ID for this version to ensure data separation
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'finance-tracker-bulk-app';
            window.__app_id = appId; // Make it globally accessible for Firestore paths

            // De Firebase configuratie is nu direct hieronder geplakt.
            // Deze is afkomstig van jouw Firebase project: schkas-66d27
            let firebaseConfig = {
                apiKey: "AIzaSyCORzv-FVt-7ZUxMBUsmaTl9ZAGcgZk8io",
                authDomain: "schkas-66d27.firebaseapp.com",
                projectId: "schkas-66d27",
                storageBucket: "schkas-66d27.firebasestorage.app",
                messagingSenderId: "987453212703",
                appId: "1:987453212703:web:dcee394027367b74df2d2a",
                measurementId: "G-9M60TQGKJZ" // Added measurementId for consistency
            };

            if (Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase configuratie is onvolledig of nog steeds een placeholder. Persistente opslag zal niet werken. Werk firebaseConfig bij met je echte Firebase projectgegevens.");
                // We gaan door met initialisatie om de app niet volledig te breken,
                // maar Firestore-bewerkingen zullen mislukken.
            }

            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Listen for authentication state changes
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    console.log("Gebruiker geauthenticeerd:", window.userId);
                    window.isAuthReady = true;
                    // Zodra authenticatie klaar is, laad transacties
                    loadTransactions(); // Still load to populate window.transactions for consistency
                    document.getElementById('currentUserId').textContent = window.userId; // Display user ID
                } else {
                    // User is not signed in, redirect to auth.html
                    console.log("Geen gebruiker gevonden, doorsturen naar auth.html.");
                    window.location.href = 'auth.html';
                }
            });
        };

        // BTW-percentage (aanpasbaar)
        const VAT_RATE = 0.21; // 21%

        // Categorieën waarop BTW teruggevorderd kan worden voor uitgaven
        const RECOVERABLE_VAT_EXPENSE_CATEGORIES = [
            "Producten",
            "Nutsvoorziening",
            "Boekhouder",
            "Verzekeringen",
            "Marketing",
            "Software",
            "Verbruiksartikelen"
        ];

        // Definieer subcategorieën
        const subcategoriesData = {
            treatments: ["Suikerontharing", "Laserontharing", "Nagels", "Manicure", "Pedicure", "Gelaatsverzorging", "Massage", "Wimpers/brows", "Spraytan", "Make up", "LPG", "Andere"],
            sales: ["Biologique Recherche", "I AM KLEAN", "LPG", "Atelier Rebul", "Lash Extend", "Lamination", "Pandhys", "OPI", "Abonnementen", "Cadeaubon", "Footlogix", "Andere"],
            expenses: ["Lonen", "Derden", "Huur", "Producten", "Nutsvoorziening", "Boekhouder", "Verzekeringen", "Marketing", "Andere", "Software", "Leasing", "Afbetaling", "Loonkost", "Verbruiksartikelen"]
        };

        // Definieer personen (voor Ingevoerd door)
        const persons = ["Marlien", "Kimberly", "Yasmine", "Jade"];

        // Definieer transactietypes en inkomstencategorieën
        const transactionTypes = [
            { value: 'income', text: 'Inkomst' },
            { value: 'expense', text: 'Uitgave' }
        ];

        const incomeCategories = [
            { value: 'treatments', text: 'Behandelingen' },
            { value: 'sales', text: 'Verkoop' }
        ];

        // Definieer betalingsopties
        const paymentOptions = ["Cash", "Payconiq/BC", "Cadeaubon", "Abonnement"];

        /**
         * Genereert en vult de kwartaalopties in het dropdownmenu.
         * @param {HTMLElement} selectElement - Het select element om te vullen.
         * @param {string} [defaultValue] - De standaardwaarde die geselecteerd moet worden.
         */
        window.generateQuarterOptions = function(selectElement, defaultValue = null) {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const currentQuarter = Math.floor(currentMonth / 3) + 1; // 1-4

            let optionsHtml = '';
            // Genereer voor vorig jaar, huidig jaar en volgend jaar
            for (let year = currentYear - 1; year <= currentYear + 1; year++) {
                for (let q = 1; q <= 4; q++) {
                    const quarterString = `${year} Q${q}`;
                    optionsHtml += `<option value="${quarterString}">${quarterString}</option>`;
                }
            }
            selectElement.innerHTML = optionsHtml;

            // Stel standaard in op het huidige kwartaal of de opgegeven waarde
            const defaultQuarterString = defaultValue || `${currentYear} Q${currentQuarter}`;
            if (selectElement.querySelector(`option[value="${defaultQuarterString}"]`)) {
                selectElement.value = defaultQuarterString;
            }
        }

        /**
         * Vult de dropdown met transactietypes.
         * @param {HTMLElement} selectElement - Het select element om te vullen.
         * @param {string} [defaultValue] - De standaardwaarde die geselecteerd moet worden.
         */
        window.populateTransactionTypes = function(selectElement, defaultValue = null) {
            let optionsHtml = '';
            transactionTypes.forEach(type => {
                optionsHtml += `<option value="${type.value}">${type.text}</option>`;
            });
            selectElement.innerHTML = optionsHtml;
            if (defaultValue && selectElement.querySelector(`option[value="${defaultValue}"]`)) {
                selectElement.value = defaultValue;
            }
        }

        /**
         * Vult de dropdown met inkomstencategorieën.
         * @param {HTMLElement} selectElement - Het select element om te vullen.
         * @param {string} [defaultValue] - De standaardwaarde die geselecteerd moet worden.
         */
        window.populateIncomeCategories = function(selectElement, defaultValue = null) {
            let optionsHtml = '';
            incomeCategories.forEach(category => {
                optionsHtml += `<option value="${category.value}">${category.text}</option>`;
            });
            selectElement.innerHTML = optionsHtml;
            if (defaultValue && selectElement.querySelector(`option[value="${defaultValue}"]`)) {
                selectElement.value = defaultValue;
            }
        }

        /**
         * Vult de dropdown met personen.
         * @param {HTMLElement} selectElement - Het select element om te vullen.
         * @param {string} [defaultValue] - De standaardwaarde die geselecteerd moet worden.
         */
        window.populatePersons = function(selectElement, defaultValue = null) {
            let optionsHtml = '';
            persons.forEach(person => {
                optionsHtml += `<option value="${person}">${person}</option>`;
            });
            selectElement.innerHTML = optionsHtml;
            if (defaultValue && selectElement.querySelector(`option[value="${defaultValue}"]`)) {
                selectElement.value = defaultValue;
            }
        }

        /**
         * Vult de dropdown met betalingsopties.
         * @param {HTMLElement} selectElement - Het select element om te vullen.
         * @param {string} [defaultValue] - De standaardwaarde die geselecteerd moet worden.
         */
        window.populatePaymentOptions = function(selectElement, defaultValue = null) {
            let optionsHtml = '';
            paymentOptions.forEach(option => {
                optionsHtml += `<option value="${option}">${option}</option>`;
            });
            selectElement.innerHTML = optionsHtml;
            if (defaultValue && selectElement.querySelector(`option[value="${defaultValue}"]`)) {
                selectElement.value = defaultValue;
            }
        }

        /**
         * Schakelt de zichtbaarheid van de inkomstencategorie-selectie en specifieke velden in of uit,
         * en vult de subcategorieën op basis van de geselecteerde typen.
         * @param {HTMLElement} [containerElement] - De container van de invoervelden (voor bulk invoer).
         */
        window.toggleCategory = function(containerElement = document) {
            const typeSelect = containerElement.querySelector('[id^="typeSelect"]');
            const incomeCategoryGroup = containerElement.querySelector('[id^="incomeCategoryGroup"]');
            const subcategoryGroup = containerElement.querySelector('[id^="subcategoryGroup"]');
            const subcategorySelect = containerElement.querySelector('[id^="subcategorySelect"]');
            const customerNameGroup = containerElement.querySelector('[id^="customerNameGroup"]');
            const productNameGroup = containerElement.querySelector('[id^="productNameGroup"]');
            const invoiceDateGroup = containerElement.querySelector('[id^="invoiceDateGroup"]');
            const remarksGroup = containerElement.querySelector('[id^="remarksGroup"]');
            const incomeCategorySelect = containerElement.querySelector('[id^="incomeCategorySelect"]');


            // Reset alle specifieke velden naar verborgen
            if (customerNameGroup) customerNameGroup.style.display = 'none';
            if (productNameGroup) productNameGroup.style.display = 'none';
            if (invoiceDateGroup) invoiceDateGroup.style.display = 'none';
            if (remarksGroup) remarksGroup.style.display = 'none';
            if (subcategorySelect) subcategorySelect.innerHTML = ''; // Wis bestaande subcategorie opties

            if (typeSelect && typeSelect.value === 'income') {
                if (incomeCategoryGroup) incomeCategoryGroup.style.display = 'block';

                const incomeCategory = incomeCategorySelect ? incomeCategorySelect.value : null;
                if (incomeCategory === 'treatments') {
                    if (customerNameGroup) customerNameGroup.style.display = 'block';
                    if (subcategorySelect) populateSubcategories(subcategorySelect, 'treatments');
                } else if (incomeCategory === 'sales') {
                    if (productNameGroup) productNameGroup.style.display = 'block';
                    if (subcategorySelect) populateSubcategories(subcategorySelect, 'sales');
                }
            } else { // typeSelect.value === 'expense'
                if (incomeCategoryGroup) incomeCategoryGroup.style.display = 'none';
                if (invoiceDateGroup) invoiceDateGroup.style.display = 'block';
                if (remarksGroup) remarksGroup.style.display = 'block';
                if (subcategorySelect) populateSubcategories(subcategorySelect, 'expenses');
            }
            if (subcategoryGroup) subcategoryGroup.style.display = 'block'; // Toon altijd subcategorie
        }

        /**
         * Vult de subcategorie dropdown op basis van de geselecteerde hoofdcategorie.
         * @param {HTMLElement} selectElement - Het select element om te vullen.
         * @param {string} categoryKey - De sleutel van de categorie (bijv. 'treatments', 'sales', 'expenses').
         * @param {string} [defaultValue] - De standaardwaarde die geselecteerd moet worden.
         */
        function populateSubcategories(selectElement, categoryKey, defaultValue = null) {
            const options = subcategoriesData[categoryKey] || [];
            let optionsHtml = '';
            options.forEach(sub => {
                optionsHtml += `<option value="${sub}">${sub}</option>`;
            });
            selectElement.innerHTML = optionsHtml;
            if (defaultValue && selectElement.querySelector(`option[value="${defaultValue}"]`)) {
                selectElement.value = defaultValue;
            }
        }

        /**
         * Werkt de achtergrondkleur van de type select dropdown bij.
         * @param {HTMLElement} [selectElement] - Het select element om de kleur van aan te passen.
         */
        window.updateTypeColor = function(selectElement) {
            if (!selectElement) return;
            selectElement.classList.remove('bg-income', 'bg-expense');
            if (selectElement.value === 'income') {
                selectElement.classList.add('bg-income');
            } else {
                selectElement.classList.add('bg-expense');
            }
        }

        /**
         * Werkt de achtergrondkleur van de inkomstencategorie select dropdown bij.
         * @param {HTMLElement} [selectElement] - Het select element om de kleur van aan te passen.
         */
        window.updateIncomeCategoryColor = function(selectElement) {
            if (!selectElement) return;
            selectElement.classList.remove('bg-treatments', 'bg-sales');
            if (selectElement.value === 'treatments') {
                selectElement.classList.add('bg-treatments');
            } else if (selectElement.value === 'sales') {
                selectElement.classList.add('bg-sales');
            }
        }

        /**
         * Navigeert terug naar de landingspagina.
         */
        window.navigateToHome = function() { // Added window. to make it globally accessible
            // Nu relatief aan de <base> href
            window.location.href = 'index.html';
        }

        /**
         * Toon/verberg de laadindicator.
         * @param {boolean} show - True om te tonen, false om te verbergen.
         */
        function showLoadingIndicator(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = show ? 'flex' : 'none';
            }
            window.isLoading = show;
        }

        /**
         * Voegt een nieuwe rij toe voor bulktransactie-invoer.
         * @param {object} [transaction] - Optioneel transactieobject om de rij mee te vullen (voor bewerken).
         */
        window.addBulkTransactionRow = function(transaction = null) {
            const container = document.getElementById('bulkTransactionContainer');
            const newRow = document.createElement('div');
            newRow.className = 'bulk-transaction-row';
            // Use transaction ID if editing, otherwise generate a temporary unique ID for new rows
            const rowId = transaction ? transaction.id : `bulkRow_${Date.now()}`;

            newRow.innerHTML = `
                <button class="remove-row-btn" onclick="removeBulkTransactionRow(this)">X</button>
                <div class="input-group">
                    <label for="quarterSelect_${rowId}">Kwartaal:</label>
                    <select id="quarterSelect_${rowId}"></select>
                </div>
                <div class="input-group">
                    <label for="typeSelect_${rowId}">Type Transactie:</label>
                    <select id="typeSelect_${rowId}" onchange="toggleCategory(this.closest('.bulk-transaction-row')); updateTypeColor(this)"></select>
                </div>
                <div class="input-group" id="incomeCategoryGroup_${rowId}">
                    <label for="incomeCategorySelect_${rowId}">Inkomst Categorie:</label>
                    <select id="incomeCategorySelect_${rowId}" onchange="toggleCategory(this.closest('.bulk-transaction-row'); updateIncomeCategoryColor(this)"></select>
                </div>
                <div class="input-group" id="subcategoryGroup_${rowId}">
                    <label for="subcategorySelect_${rowId}">Subcategorie:</label>
                    <select id="subcategorySelect_${rowId}"></select>
                </div>
                <div class="input-group" id="customerNameGroup_${rowId}" style="display:none;">
                    <label for="customerNameInput_${rowId}">Klantnaam:</label>
                    <input type="text" id="customerNameInput_${rowId}" placeholder="Naam van de klant">
                </div>
                <div class="input-group" id="productNameGroup_${rowId}" style="display:none;">
                    <label for="productNameInput_${rowId}">Productnaam:</label>
                    <input type="text" id="productNameInput_${rowId}" placeholder="Naam van het product">
                </div>
                <div class="input-group">
                    <label for="paymentMethodSelect_${rowId}">Betaling:</label>
                    <select id="paymentMethodSelect_${rowId}"></select>
                </div>
                <div class="input-group">
                    <label for="amountInput_${rowId}">Bedrag (€):</label>
                    <input type="number" id="amountInput_${rowId}" placeholder="0.00" step="0.01">
                    <p id="amountError_${rowId}" class="error-message">Voer een geldig bedrag in.</p>
                </div>
                <div class="input-group" id="invoiceDateGroup_${rowId}" style="display:none;">
                    <label for="invoiceDateInput_${rowId}">Factuurdatum:</label>
                    <input type="date" id="invoiceDateInput_${rowId}">
                </div>
                <div class="input-group">
                    <label for="remarksInput_${rowId}">Opmerkingen:</label>
                    <textarea id="remarksInput_${rowId}" placeholder="Eventuele opmerkingen"></textarea>
                </div>
                <div class="input-group">
                    <label for="personInput_${rowId}">Ingevoerd door:</label>
                    <select id="personInput_${rowId}"></select>
                </div>
                <input type="hidden" id="transactionIdToEdit_${rowId}" value="${transaction ? transaction.id : ''}">
            `;
            container.appendChild(newRow);

            // Get references to the elements in the new row
            const quarterSelect = newRow.querySelector(`[id^="quarterSelect_"]`);
            const typeSelect = newRow.querySelector(`[id^="typeSelect_"]`);
            const incomeCategorySelect = newRow.querySelector(`[id^="incomeCategorySelect_"]`);
            const subcategorySelect = newRow.querySelector(`[id^="subcategorySelect_"]`);
            const paymentMethodSelect = newRow.querySelector(`[id^="paymentMethodSelect_"]`);
            const amountInput = newRow.querySelector(`[id^="amountInput_"]`);
            const personInput = newRow.querySelector(`[id^="personInput_"]`);
            const customerNameInput = newRow.querySelector(`[id^="customerNameInput_"]`);
            const productNameInput = newRow.querySelector(`[id^="productNameInput_"]`);
            const invoiceDateInput = newRow.querySelector(`[id^="invoiceDateInput_"]`);
            const remarksInput = newRow.querySelector(`[id^="remarksInput_"]`);

            // Populate dropdowns for the new row
            window.generateQuarterOptions(quarterSelect, transaction ? transaction.quarter : null);
            window.populateTransactionTypes(typeSelect, transaction ? transaction.type : null);
            window.populateIncomeCategories(incomeCategorySelect, transaction ? transaction.category : null);
            window.populatePersons(personInput, transaction ? transaction.person : null);
            window.populatePaymentOptions(paymentMethodSelect, transaction ? transaction.paymentMethod : null);

            // Set other fields and toggle visibility based on transaction data
            if (transaction) {
                amountInput.value = transaction.amount;
                if (transaction.type === 'income') {
                    if (transaction.category === 'treatments') {
                        customerNameInput.value = transaction.customerName || '';
                    } else if (transaction.category === 'sales') {
                        productNameInput.value = transaction.productName || '';
                    }
                } else { // expense
                    invoiceDateInput.value = transaction.invoiceDate || '';
                    remarksInput.value = transaction.remarks || '';
                }
            }

            window.toggleCategory(newRow); // Initialize visibility and subcategories for the new row
            if (transaction) {
                // After toggleCategory, populate subcategory with specific value
                populateSubcategories(subcategorySelect, transaction.type === 'income' ? transaction.category : 'expenses', transaction.subcategory);
            }
            window.updateTypeColor(typeSelect);
            window.updateIncomeCategoryColor(incomeCategorySelect);
        }

        /**
         * Verwijdert een bulktransactie-rij.
         * @param {HTMLElement} button - De verwijderknop die is geklikt.
         */
        window.removeBulkTransactionRow = function(button) {
            button.closest('.bulk-transaction-row').remove();
        }

        /**
         * Handelt het toevoegen van meerdere transacties vanuit de bulk-invoer.
         */
        window.handleBulkTransactions = async function() {
            showLoadingIndicator(true); // Toon laadindicator
            try {
                const bulkRows = document.querySelectorAll('.bulk-transaction-row');
                const transactionsToSave = [];
                let hasErrors = false;

                if (!window.db) {
                    console.error("Firestore is niet geïnitialiseerd.");
                    showLoadingIndicator(false); // Verberg laadindicator bij fout
                    return;
                }

                for (const row of bulkRows) {
                    const rowIdElement = row.querySelector('[id^="transactionIdToEdit_"]');
                    const rowId = rowIdElement ? rowIdElement.value : null; // Get the ID, if it exists

                    const quarter = row.querySelector('[id^="quarterSelect_"]').value;
                    const type = row.querySelector('[id^="typeSelect_"]').value;
                    const incomeCategorySelect = row.querySelector('[id^="incomeCategorySelect_"]');
                    const subcategory = row.querySelector('[id^="subcategorySelect_"]').value;
                    const paymentMethod = row.querySelector('[id^="paymentMethodSelect_"]').value;
                    const amountInput = row.querySelector('[id^="amountInput_"]');
                    const person = row.querySelector('[id^="personInput_"]').value;
                    const customerNameInput = row.querySelector('[id^="customerNameInput_"]');
                    const productNameInput = row.querySelector('[id^="productNameInput_"]');
                    const invoiceDateInput = row.querySelector('[id^="invoiceDateInput_"]');
                    const remarksInput = row.querySelector('[id^="remarksInput_"]');
                    const amountError = row.querySelector('[id^="amountError_"]');

                    const amount = parseFloat(amountInput.value);

                    if (isNaN(amount) || amount <= 0) {
                        amountError.style.display = 'block';
                        hasErrors = true;
                        continue; // Skip to next row if amount is invalid
                    } else {
                        amountError.style.display = 'none';
                    }

                    let transactionData = {
                        quarter: quarter,
                        type: type,
                        paymentMethod: paymentMethod,
                        amount: amount,
                        timestamp: new Date().toISOString(), // Automatisch gegenereerde datum
                        person: person,
                        subcategory: subcategory
                    };

                    if (type === 'income') {
                        transactionData.category = incomeCategorySelect.value;
                        if (incomeCategorySelect.value === 'treatments') {
                            transactionData.customerName = customerNameInput.value.trim();
                        } else if (incomeCategorySelect.value === 'sales') {
                            transactionData.productName = productNameInput.value.trim();
                        }
                    } else { // expense
                        transactionData.category = 'N.v.t.';
                        transactionData.invoiceDate = invoiceDateInput.value;
                        transactionData.remarks = remarksInput.value.trim();
                    }
                    transactionsToSave.push({ id: rowId, data: transactionData });
                }

                if (hasErrors) {
                    console.error("Sommige bulktransacties bevatten fouten. Controleer de gemarkeerde velden.");
                    showLoadingIndicator(false); // Verberg laadindicator bij fout
                    return;
                }
                if (transactionsToSave.length === 0) {
                    console.warn("Geen transacties om toe te voegen.");
                    showLoadingIndicator(false); // Verberg laadindicator als er niets te doen is
                    return;
                }

                const transactionsCollection = window.collection(window.db, `artifacts/${window.__app_id}/public/data/transactions`);
                const promises = transactionsToSave.map(item => {
                    if (item.id && !item.id.startsWith('bulkRow_')) {
                        const transactionRef = window.doc(window.db, `artifacts/${window.__app_id}/public/data/transactions`, item.id);
                        return window.updateDoc(transactionRef, item.data);
                    } else {
                        return window.addDoc(transactionsCollection, item.data);
                    }
                });
                await Promise.all(promises);
                console.log(`${transactionsToSave.length} transacties succesvol toegevoegd/bijgewerkt.`);
                window.playPingSound(); // Speel geluid na succesvolle invoer

                // Clear all bulk input rows after successful submission and add one new empty row
                document.getElementById('bulkTransactionContainer').innerHTML = '';
                window.addBulkTransactionRow(); // Add an empty row for new input

            } catch (e) {
                console.error("Fout bij het toevoegen/bijwerken van bulktransacties:", e);
            } finally {
                showLoadingIndicator(false); // Verberg laadindicator altijd aan het einde
            }
        }


        /**
         * Laadt transacties van Firestore en luistert naar real-time updates.
         * Op deze pagina wordt alleen de data geladen, niet weergegeven.
         */
        window.loadTransactions = function() {
            showLoadingIndicator(true); // Toon laadindicator
            if (!window.db || !window.userId) { // Ensure userId is available
                console.error("Firestore of User ID is niet geïnitialiseerd. Kan transacties niet laden.");
                showLoadingIndicator(false); // Verberg laadindicator bij fout
                return;
            }

            const transactionsCollectionRef = window.collection(window.db, `artifacts/${window.__app_id}/public/data/transactions`);
            window.onSnapshot(window.query(transactionsCollectionRef, window.orderBy('timestamp', 'desc')), (snapshot) => {
                window.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Transacties geladen/bijgewerkt:", window.transactions);

                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('editId');

                if (editId && window.transactions.length > 0) {
                    const transactionToEdit = window.transactions.find(t => t.id === editId);
                    if (transactionToEdit) {
                        // Clear existing rows and add the one to edit
                        document.getElementById('bulkTransactionContainer').innerHTML = '';
                        window.addBulkTransactionRow(transactionToEdit);
                        // Remove the editId from the URL after loading
                        history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        console.warn(`Transactie met ID ${editId} niet gevonden.`);
                        window.addBulkTransactionRow(); // Add a default empty row
                    }
                } else if (document.querySelectorAll('.bulk-transaction-row').length === 0) {
                    // Only add a default row if no rows exist (e.g., on initial load without editId)
                    window.addBulkTransactionRow();
                }
                showLoadingIndicator(false); // Verberg laadindicator na het laden
            }, (error) => {
                console.error("Fout bij laden transacties (onSnapshot error callback):", error);
                showLoadingIndicator(false); // Verberg laadindicator bij fout
            });
        }

        // Functie om af te melden
        window.logoutUser = function() {
            signOut(window.auth).then(() => {
                console.log("Succesvol afgemeld.");
                window.location.href = 'auth.html'; // Terug naar inlogpagina
            }).catch((error) => {
                console.error("Fout bij afmelden:", error);
                // Hier zou je een custom melding kunnen tonen in plaats van alert
                alert("Fout bij afmelden. Probeer opnieuw.");
            });
        }

        // Initialiseer Firebase en audio bij het laden van de pagina
        window.onload = function() {
            window.initFirebase();
            window.initAudio();
            // Voeg event listener toe voor de afmeldknop
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', window.logoutUser);
            }
        };
    </script>
    <style>
        body {
            font-family: 'Calibri', sans-serif;
            background-color: #e0f2f7;
            color: #4a5568;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
            position: relative; /* Voor de laadindicator */
        }
        .header-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-container .logo-small {
            max-width: 80px;
            height: auto;
            margin-right: 20px;
            border-radius: 8px;
        }
        h1 {
            color: #2c5282;
            font-size: 2.2rem;
            flex-grow: 1;
            text-align: center;
        }
        h2 {
            font-size: 1.8rem;
            margin-top: 30px;
            text-align: center;
            color: #2c5282;
        }
        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #a0aec0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        button {
            background-color: #63b3ed;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        button:hover {
            background-color: #4299e1;
            transform: translateY(-2px);
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .user-id-display {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #718096;
        }
        .error-message {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 15px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bulk Transaction Specific Styles */
        .bulk-transaction-row {
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f7fafc;
            position: relative;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .bulk-transaction-row .remove-row-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            padding: 0; /* Remove padding to make it a perfect circle */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease;
        }
        .bulk-transaction-row .remove-row-btn:hover {
            background-color: #c53030;
            transform: scale(1.05);
        }

        /* Background colors for select options */
        .bg-income { background-color: #9ae6b4; } /* Light green */
        .bg-expense { background-color: #feb2b2; } /* Light red */
        .bg-treatments { background-color: #bee3f8; } /* Light blue */
        .bg-sales { background-color: #fbd38d; } /* Light orange */

        /* Override button styles for the "Afmelden" button */
        button#logoutBtn {
            background-color: #ef4444; /* Red for logout */
        }
        button#logoutBtn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <img src="Black logo - no background.png" alt="Bedrijfslogo" class="logo-small" onerror="this.onerror=null;this.src='https://placehold.co/80x80/000/fff?text=Logo+Niet+Gevonden';">
            <h1>Financiële Tracker - Invoer</h1>
        </div>

        <div class="user-id-display">
            Je gebruikers-ID: <span id="currentUserId">Laden...</span>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
        </div>

        <div class="input-section">
            <h2 class="text-xl font-semibold mb-4">Nieuwe Transactie Invoeren</h2>
            <div id="bulkTransactionContainer">
                <!-- Bulk transactie rijen worden hier dynamisch toegevoegd -->
            </div>
            <div class="button-group">
                <button onclick="addBulkTransactionRow()">Rij Toevoegen</button>
                <button onclick="handleBulkTransactions()">Transacties Opslaan</button>
            </div>
        </div>

        <div class="button-group">
            <button onclick="navigateToHome()">Terug naar Start</button>
            <button id="logoutBtn">Afmelden</button>
        </div>
    </div>
</body>
</html>
