<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financiële Tracker - Facturen Opmaken</title>
    <base href="/kas/"> <!-- Belangrijke toevoeging voor juiste paden op GitHub Pages -->
    <link rel="manifest" href="manifest.json"> <!-- Link naar het PWA manifest bestand -->
    <script>
        // Registreer de Service Worker voor PWA functionaliteit
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.isLoading = false; // Nieuwe globale variabele voor laadstatus

        // Make Firestore functions globally available
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.getDoc = getDoc;
        window.writeBatch = writeBatch;

        // Initialize Firebase and set up authentication
        window.initFirebase = async () => {
            const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'finance-tracker-bulk-app';
            window.APP_ID = APP_ID;

            let firebaseConfig = {
              apiKey: "AIzaSyCORzv-FVt-7ZUxMBUsmaTl9ZAGcgZk8io",
              authDomain: "schkas-66d27.firebaseapp.com",
              projectId: "schkas-66d27",
              storageBucket: "schkas-66d27.firebasestorage.app",
              messagingSenderId: "987453212703",
              appId: "1:987453212703:web:dcee394027367b74df2d2a",
              measurementId: "G-9M60TQGKJZ"
            };

            if (Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase configuratie is onvolledig of nog steeds een placeholder. Persistente opslag zal niet werken. Werk firebaseConfig bij met je echte Firebase projectgegevens.");
            }

            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.userId = user.uid;
                    window.isAuthReady = true;
                    loadInvoices(); // Load invoices once authenticated
                } else {
                    window.location.href = 'auth.html';
                }
            });
        };

        // --- Invoice Management Functions ---
        window.invoices = []; // Global array to store invoices

        /**
         * Laadt facturen van Firestore en luistert naar real-time updates.
         */
        window.loadInvoices = function() {
            showLoadingIndicator(true);
            if (!window.db || !window.userId) {
                console.error("Firestore of User ID is niet geïnitialiseerd. Kan facturen niet laden.");
                showLoadingIndicator(false);
                return;
            }

            // Reference to the public invoices collection
            const invoicesCollectionRef = collection(window.db, `artifacts/${window.APP_ID}/public/data/invoices`);

            onSnapshot(query(invoicesCollectionRef, orderBy('invoiceDate', 'desc')), (snapshot) => {
                window.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInvoices();
                showLoadingIndicator(false);
            }, (error) => {
                console.error("Fout bij laden facturen:", error);
                showMessageBox("Fout bij het laden van facturen. Probeer opnieuw.");
                showLoadingIndicator(false);
            });
        };

        /**
         * Rendert de lijst met facturen in de tabel.
         */
        function renderInvoices() {
            const tbody = document.getElementById('invoicesTableBody');
            tbody.innerHTML = ''; // Clear existing rows

            if (window.invoices.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.className = 'text-center py-4 text-gray-600';
                cell.textContent = 'Geen facturen gevonden.';
                return;
            }

            window.invoices.forEach(invoice => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';

                row.insertCell().textContent = invoice.invoiceNumber;
                row.insertCell().textContent = invoice.customerName;
                row.insertCell().textContent = invoice.invoiceDate;
                row.insertCell().textContent = `€ ${invoice.totalAmount.toFixed(2)}`;
                row.insertCell().textContent = invoice.status;
                row.insertCell().textContent = invoice.remarks;

                const actionsCell = row.insertCell();
                actionsCell.className = 'flex space-x-2 justify-center';

                const editBtn = document.createElement('button');
                editBtn.className = 'bg-yellow-500 hover:bg-yellow-700 text-white px-3 py-1 rounded-md text-sm';
                editBtn.textContent = 'Bewerk';
                editBtn.onclick = () => editInvoice(invoice.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm';
                deleteBtn.textContent = 'Verwijder';
                deleteBtn.onclick = () => deleteInvoice(invoice.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        /**
         * Navigeert naar het factuurformulier om een bestaande factuur te bewerken.
         * @param {string} invoiceId - De ID van de te bewerken factuur.
         */
        window.editInvoice = function(invoiceId) {
            // Implementeer de logica om naar een formulierpagina te navigeren met de factuur-ID
            // Voor nu, een eenvoudige placeholder
            showMessageBox(`Factuur met ID: ${invoiceId} bewerken (functionaliteit nog te implementeren).`);
            // Idealiter: window.location.href = `invoice_form.html?editId=${invoiceId}`;
        };

        /**
         * Verwijdert een factuur uit Firestore.
         * @param {string} invoiceId - De ID van de te verwijderen factuur.
         */
        window.deleteInvoice = async function(invoiceId) {
            const confirmDelete = confirm("Weet je zeker dat je deze factuur wilt verwijderen?");
            if (!confirmDelete) {
                return;
            }

            showLoadingIndicator(true);
            try {
                await deleteDoc(doc(window.db, `artifacts/${window.APP_ID}/public/data/invoices`, invoiceId));
                showMessageBox("Factuur succesvol verwijderd!");
            } catch (e) {
                console.error("Fout bij het verwijderen van factuur:", e);
                showMessageBox("Fout bij het verwijderen van factuur. Probeer opnieuw.");
            } finally {
                showLoadingIndicator(false);
            }
        };

        /**
         * Toont/verbergt de laadindicator.
         * @param {boolean} show - True om te tonen, false om te verbergen.
         */
        function showLoadingIndicator(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = show ? 'flex' : 'none';
            }
            window.isLoading = show;
        }

        // Custom message box function (replaces alert() and confirm())
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
                max-width: 300px;
                border: 1px solid #ccc;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button style="margin-top: 15px; padding: 8px 15px; background-color: #63b3ed; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
            `;
            document.body.appendChild(messageBox);

            messageBox.querySelector('button').onclick = () => {
                document.body.removeChild(messageBox);
            };
        }

        // Initialiseer de app bij het laden van de pagina
        window.onload = function() {
            window.initFirebase();
            document.getElementById('backToMainBtn').addEventListener('click', () => window.location.href = 'index.html');
        };
    </script>
    <style>
        body {
            font-family: 'Calibri', sans-serif;
            background-color: #e0f2f7;
            color: #4a5568;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            width: 100%;
            text-align: center;
            position: relative;
        }
        h1 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 2.2rem;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        button {
            background-color: #63b3ed;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        button:hover {
            background-color: #4299e1;
            transform: translateY(-2px);
        }
        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 15px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        th {
            background-color: #edf2f7;
            font-weight: bold;
            color: #2d3748;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        /* Specific button styling for actions */
        .bg-yellow-500 { background-color: #ecc94b; }
        .bg-yellow-500:hover { background-color: #d69e2e; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-red-500:hover { background-color: #dc2626; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Facturen Opmaken</h1>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
        </div>

        <div class="button-group">
            <button onclick="window.location.href='invoice_form.html'">Nieuwe Factuur Maken</button>
        </div>

        <div class="mt-8 overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th>Factuurnummer</th>
                        <th>Klantnaam</th>
                        <th>Factuurdatum</th>
                        <th>Totaalbedrag</th>
                        <th>Status</th>
                        <th>Opmerkingen</th>
                        <th>Acties</th>
                    </tr>
                </thead>
                <tbody id="invoicesTableBody">
                    <!-- Facturen worden hier dynamisch geladen -->
                </tbody>
            </table>
        </div>

        <div class="button-group mt-8">
            <button id="backToMainBtn">Terug naar Hoofdpagina</button>
        </div>
    </div>
</body>
</html>
