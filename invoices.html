<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturen Opmaken - Financiële Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Calibri', sans-serif;
            background-color: #e0f2f7;
            color: #4a5568;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px; /* Increased max-width to accommodate saved invoices list */
            width: 100%;
            text-align: center;
            margin-top: 20px; /* Add some margin from the top */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        h1 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2d3748;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        button {
            background-color: #63b3ed;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #4299e1;
            transform: translateY(-2px);
        }

        #invoiceOutput {
            margin-top: 30px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background-color: #f7fafc;
            text-align: left;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            min-height: 200px;
            overflow-y: auto;
        }

        #invoiceOutput h2 {
            color: #2c5282;
            margin-bottom: 15px;
            font-size: 1.8rem;
            text-align: center;
        }

        #invoiceOutput p {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        #invoiceOutput .invoice-header,
        #invoiceOutput .invoice-details,
        #invoiceOutput .invoice-summary,
        #invoiceOutput .invoice-footer {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #cbd5e0;
        }
        #invoiceOutput .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Aligns items to the top of the flex container */
            flex-wrap: wrap;
            margin-top: 20px; /* Space below the logo and Factuur title */
        }
        #invoiceOutput .invoice-header div {
            flex: 1;
            min-width: 250px;
            margin-bottom: 10px;
        }
        #invoiceOutput .invoice-header .company-info {
            text-align: left;
            flex-grow: 1; /* Allow it to grow */
            margin-right: 20px; /* Space between company and client info */
        }
        #invoiceOutput .invoice-header .client-info {
            text-align: left; /* Keep text left aligned within its box */
            border: 1px solid #cbd5e0; /* Add border */
            border-radius: 8px; /* Rounded corners for the border */
            padding: 15px; /* Add some padding inside the border */
            box-sizing: border-box; /* Include padding in the element's total width and height */
            flex-grow: 1; /* Allow it to grow */
            max-width: 350px; /* Limit width to keep it compact */
        }
        #invoiceOutput .invoice-header .company-info h3,
        #invoiceOutput .invoice-header .client-info h3 {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c5282;
        }
        /* Styling for the logo */
        #invoiceOutput .company-logo {
            max-width: 150px; /* Adjust as needed */
            height: auto;
            margin-bottom: 20px; /* Add some space below the logo */
            display: block; /* Make it a block element to take full width */
            margin-left: 0; /* Align logo to the left */
            margin-right: auto;
        }
        #invoiceOutput .invoice-details {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c5282;
        }
        #invoiceOutput .invoice-summary {
            text-align: right;
            border-top: 1px dashed #cbd5e0;
            padding-top: 10px;
            margin-top: 20px;
        }
        #invoiceOutput .invoice-summary p {
            margin-bottom: 5px;
        }
        #invoiceOutput .invoice-summary .total-amount {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c5282;
        }
        #invoiceOutput .invoice-footer {
            border-bottom: none;
            text-align: center;
            font-size: 0.9rem;
            color: #718096;
        }

        /* Styling for product lines table */
        .invoice-items table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .invoice-items th, .invoice-items td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: left;
        }
        .invoice-items th {
            background-color: #edf2f7;
            font-weight: bold;
            color: #2d3748;
        }
        .invoice-items td.text-right {
            text-align: right;
        }

        /* Product line input styling */
        .product-line-item {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Smaller gap for inputs */
            margin-bottom: 10px;
            align-items: flex-end;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f0f8ff;
        }
        .product-line-item > div {
            flex: 1;
            min-width: 120px; /* Adjust min-width for smaller screens */
        }
        .product-line-item input[type="text"],
        .product-line-item input[type="number"] {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e0;
        }
        .product-line-item button {
            padding: 8px 12px;
            font-size: 0.9rem;
            min-width: unset; /* Override general button width */
            aspect-ratio: unset;
            height: 40px; /* Fixed height for remove button */
        }

        /* Saved Invoices List Styling */
        #savedInvoicesSection {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background-color: #f7fafc;
            text-align: left;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        #savedInvoicesList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #savedInvoicesList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #cbd5e0;
        }
        #savedInvoicesList li:last-child {
            border-bottom: none;
        }
        #savedInvoicesList .invoice-item-details {
            flex-grow: 1;
            margin-right: 10px;
        }
        #savedInvoicesList .invoice-item-actions button {
            margin-left: 10px;
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        #savedInvoicesList .invoice-item-actions .edit-button {
            background-color: #48bb78; /* Green for edit */
        }
        #savedInvoicesList .invoice-item-actions .edit-button:hover {
            background-color: #38a169;
        }
        #savedInvoicesList .invoice-item-actions .delete-button {
            background-color: #ef4444; /* Red for delete */
        }
        #savedInvoicesList .invoice-item-actions .delete-button:hover {
            background-color: #dc2626;
        }
        #savedInvoicesList .invoice-item-actions .export-list-button {
            background-color: #3182ce; /* Blue for export */
        }
        #savedInvoicesList .invoice-item-actions .export-list-button:hover {
            background-color: #2b6cb0;
        }

        /* Hide form elements when printing */
        @media print {
            body {
                background-color: #fff;
                justify-content: flex-start;
                align-items: flex-start;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
                padding: 0;
                margin-top: 0;
            }
            /* Hide the main h1 "Facturen Opmaken" during print */
            body > .container > h1 {
                display: none;
            }
            .form-section, .button-group, #savedInvoicesSection { /* Hide saved invoices section too */
                display: none;
            }
            #invoiceOutput {
                border: none;
                box-shadow: none;
                padding: 20px;
                min-height: auto;
                overflow: visible;
                width: 100%;
            }
            /* Style the h1 inside invoiceOutput for print */
            #invoiceOutput h1 {
                font-size: 2.5rem; /* Make it larger for print */
                margin-bottom: 20px;
                text-align: center; /* Center the title */
                color: #2c5282; /* Ensure color matches theme */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Facturen Opmaken</h1> <!-- This is the page title, will be hidden on print -->

        <div id="invoiceFormSection" class="form-section">
            <div class="form-group">
                <label for="clientName">Naam klant:</label>
                <input type="text" id="clientName" placeholder="Naam van de klant" required>
            </div>
            <div class="form-group">
                <label for="clientVat">BTW-nummer klant:</label>
                <input type="text" id="clientVat" placeholder="BTW-nummer (optioneel)">
            </div>
            <div class="form-group">
                <label for="clientAddress">Adres klant:</label>
                <input type="text" id="clientAddress" placeholder="Straat, huisnummer, postcode, plaats" required>
            </div>
            <div class="form-group">
                <label for="clientEmail">E-mail klant:</label>
                <input type="email" id="clientEmail" placeholder="e-mailadres@voorbeeld.be">
            </div>
            <div class="form-group">
                <label for="clientPhone">Telefoon klant:</label>
                <input type="tel" id="clientPhone" placeholder="+32 123 45 67 89">
            </div>

            <h2 class="text-xl font-bold mt-6 mb-4 text-left text-blue-800">Productlijnen</h2>
            <div id="productLinesContainer">
                <!-- Productlijnen worden hier dynamisch toegevoegd -->
                <div class="product-line-item">
                    <div class="flex-1">
                        <label for="itemDescription_1">Omschrijving:</label>
                        <input type="text" id="itemDescription_1" class="item-description" placeholder="Product/Dienst" required>
                    </div>
                    <div class="w-20">
                        <label for="itemQuantity_1">Aantal:</label>
                        <input type="number" id="itemQuantity_1" class="item-quantity" value="1" min="1" required>
                    </div>
                    <div class="w-32">
                        <label for="itemPrice_1">Prijs/stuk (incl. BTW):</label>
                        <input type="number" id="itemPrice_1" class="item-price" step="0.01" placeholder="0.00" required>
                    </div>
                    <button type="button" class="remove-product-line-btn bg-red-500 hover:bg-red-700 text-white p-2 rounded-md h-10 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                </div>
            </div>
            <button type="button" id="addProductLineBtn" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded-md mt-4">Productlijn Toevoegen</button>

            <div class="form-group mt-6">
                <label for="totalAmountDisplay">Totaal bedrag (incl. 21% BTW):</label>
                <input type="text" id="totalAmountDisplay" value="0.00" readonly class="bg-gray-100 text-right font-bold">
            </div>
            <div class="form-group">
                <label for="invoiceDate">Datum factuur:</label>
                <input type="date" id="invoiceDate" required>
            </div>

            <div class="button-group">
                <button id="generateInvoiceBtn">Factuur Genereren & Opslaan</button>
                <button id="updateInvoiceBtn" style="display: none;">Factuur Bijwerken</button>
                <button id="newInvoiceBtn">Nieuwe Factuur</button>
                <button id="backToMainBtn">Terug naar Hoofdpagina</button>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-700">Afmelden</button>
            </div>
        </div>

        <div id="invoiceOutput" class="hidden">
            <!-- The invoice content will be generated here -->
            <!-- The h1 for the invoice title will be dynamically added here -->
        </div>

        <!-- The exportButtonGroup is removed from here as per user request -->

        <div id="savedInvoicesSection">
            <h2 class="text-xl font-bold mb-4 text-blue-800">Opgeslagen Facturen</h2>
            <ul id="savedInvoicesList">
                <!-- Opgeslagen facturen worden hier geladen -->
                <p id="loadingInvoices" class="text-gray-600">Facturen laden...</p>
                <p id="noInvoices" class="text-gray-600 hidden">Geen opgeslagen facturen.</p>
            </ul>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let currentEditingInvoiceId = null; // To keep track of the invoice being edited

        // Firebase configuration (updated with user-provided config)
        const firebaseConfig = {
            apiKey: "AIzaSyCORzv-FVt-7ZUxMBUsmaTl9ZAGcgZk8io",
            authDomain: "schkas-66d27.firebaseapp.com",
            projectId: "schkas-66d27",
            storageBucket: "schkas-66d27.firebasestorage.app",
            messagingSenderId: "987453212703",
            appId: "1:987453212703:web:dcee394027367b74df2d2a",
            measurementId: "G-9M60TQGKJZ"
        };

        const companyDetails = {
            name: "Skin Clinic Heusden",
            address: "Tramstraat 24, 9070 Heusden",
            phone: "0469 16 60 28",
            email: "info@skinclinicheusden.be",
            bank: "KBC",
            iban: "BE39 7350 6786 4319",
            bic: "KREDBEBB",
            vat: "BE1013.910.910",
            logoUrl: "Black%20logo%20-%20no%20background.png" // Relative path to the logo
        };

        const VAT_RATE = 0.21; // 21% BTW
        let productLineCounter = 1; // Counter for unique IDs of product lines

        // Initialize Firebase and set up authentication
        async function initFirebase() {
            firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Gebruiker geauthenticeerd:", userId);
                    isAuthReady = true;
                    loadInvoices(); // Load invoices once authenticated
                } else {
                    // User is not signed in, redirect to auth.html
                    window.location.href = 'auth.html';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Set current date as default for invoiceDate
            document.getElementById('invoiceDate').valueAsDate = new Date();
            calculateTotalAmount(); // Calculate initial total if there's a default product line
            initFirebase(); // Initialize Firebase on page load

            // Attach event listeners to buttons and input fields
            document.getElementById('addProductLineBtn').addEventListener('click', () => addProductLine());
            document.getElementById('generateInvoiceBtn').addEventListener('click', generateAndSaveInvoice);
            document.getElementById('updateInvoiceBtn').addEventListener('click', updateInvoice);
            document.getElementById('newInvoiceBtn').addEventListener('click', clearForm);
            document.getElementById('backToMainBtn').addEventListener('click', () => window.history.back());
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);


            // Event delegation for product line inputs and remove buttons
            document.getElementById('productLinesContainer').addEventListener('input', (event) => {
                if (event.target.classList.contains('item-quantity') || event.target.classList.contains('item-price')) {
                    calculateTotalAmount();
                }
            });
            document.getElementById('productLinesContainer').addEventListener('click', (event) => {
                if (event.target.closest('.remove-product-line-btn')) {
                    removeProductLine(event.target.closest('.remove-product-line-btn'));
                }
            });
        });

        function logoutUser() {
            signOut(auth).then(() => {
                // Sign-out successful.
                window.location.href = 'auth.html';
            }).catch((error) => {
                // An error happened.
                console.error("Fout bij afmelden:", error);
                showMessageBox('Fout bij afmelden. Probeer opnieuw.');
            });
        }

        function addProductLine(description = '', quantity = 1, price = 0) {
            productLineCounter++;
            const container = document.getElementById('productLinesContainer');
            const newProductLine = document.createElement('div');
            newProductLine.classList.add('product-line-item');
            newProductLine.innerHTML = `
                <div class="flex-1">
                    <label for="itemDescription_${productLineCounter}">Omschrijving:</label>
                    <input type="text" id="itemDescription_${productLineCounter}" class="item-description" placeholder="Product/Dienst" required>
                </div>
                <div class="w-20">
                    <label for="itemQuantity_${productLineCounter}">Aantal:</label>
                    <input type="number" id="itemQuantity_${productLineCounter}" class="item-quantity" value="${quantity}" min="1" required>
                </div>
                <div class="w-32">
                    <label for="itemPrice_${productLineCounter}">Prijs/stuk (incl. BTW):</label>
                    <input type="number" id="itemPrice_${productLineCounter}" class="item-price" step="0.01" placeholder="0.00" required>
                </div>
                <button type="button" class="remove-product-line-btn bg-red-500 hover:bg-red-700 text-white p-2 rounded-md h-10 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
            </div>
            `;
            container.appendChild(newProductLine);
            calculateTotalAmount();
        }

        function removeProductLine(buttonElement) {
            const productLineItem = buttonElement.closest('.product-line-item');
            if (document.querySelectorAll('.product-line-item').length > 1) {
                productLineItem.remove();
                calculateTotalAmount(); // Recalculate total after removing a line
            } else {
                showMessageBox('U moet minstens één productlijn hebben.');
            }
        }

        function calculateTotalAmount() {
            let total = 0;
            const productLines = document.querySelectorAll('.product-line-item');
            productLines.forEach(line => {
                const quantityInput = line.querySelector('.item-quantity');
                const priceInput = line.querySelector('.item-price');

                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                total += (quantity * price);
            });
            document.getElementById('totalAmountDisplay').value = total.toFixed(2);
        }

        async function generateAndSaveInvoice() {
            const invoiceData = getFormData();

            if (!invoiceData) { // If form validation failed
                return;
            }

            // Generate invoice number before saving
            invoiceData.invoiceNumber = generateInvoiceNumber();

            // Save to Firestore
            if (isAuthReady && userId) {
                try {
                    const invoicesColRef = collection(db, `artifacts/${__app_id}/users/${userId}/invoices`);
                    await addDoc(invoicesColRef, invoiceData);
                    showMessageBox('Factuur succesvol opgeslagen!');
                    renderInvoice(invoiceData); // Display the generated invoice
                    clearForm(); // Clear form after saving
                } catch (e) {
                    console.error("Fout bij het opslaan van factuur: ", e);
                    showMessageBox('Fout bij het opslaan van factuur. Probeer opnieuw.');
                }
            } else {
                showMessageBox('Authenticatie is nog niet voltooid of er is geen gebruikers-ID. Kan factuur niet opslaan.');
                renderInvoice(invoiceData); // Still display the invoice even if not saved
            }
        }

        async function updateInvoice() {
            if (!currentEditingInvoiceId) {
                showMessageBox('Geen factuur geselecteerd om bij te werken.');
                return;
            }

            const invoiceData = getFormData();
            if (!invoiceData) {
                return;
            }

            // Keep the original invoice number when updating
            const invoiceNumberDisplayElement = document.getElementById('invoiceNumberDisplay');
            if (invoiceNumberDisplayElement) {
                invoiceData.invoiceNumber = invoiceNumberDisplayElement.textContent;
            } else {
                console.warn("invoiceNumberDisplay element not found when updating invoice. Using previously loaded invoice number.");
            }

            if (isAuthReady && userId) {
                try {
                    const invoiceDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/invoices`, currentEditingInvoiceId);
                    await updateDoc(invoiceDocRef, invoiceData);
                    showMessageBox('Factuur succesvol bijgewerkt!');
                    renderInvoice(invoiceData); // Display the updated invoice
                    clearForm(); // Clear form after updating
                } catch (e) {
                    console.error("Fout bij het bijwerken van factuur: ", e);
                    showMessageBox('Fout bij het bijwerken van factuur. Probeer opnieuw.');
                }
            } else {
                showMessageBox('Authenticatie is nog niet voltooid of er is geen gebruikers-ID. Kan factuur niet bijwerken.');
            }
        }

        function getFormData() {
            const clientName = document.getElementById('clientName').value;
            const clientVat = document.getElementById('clientVat').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientEmail = document.getElementById('clientEmail').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const totalAmountInclVat = parseFloat(document.getElementById('totalAmountDisplay').value);

            if (!clientName || !clientAddress || isNaN(totalAmountInclVat) || totalAmountInclVat <= 0 || !invoiceDate) {
                showMessageBox('Vul alstublieft alle verplichte velden in en zorg voor een positief totaalbedrag.');
                return null;
            }

            const productLines = [];
            document.querySelectorAll('.product-line-item').forEach(line => {
                const description = line.querySelector('.item-description').value;
                const quantity = parseFloat(line.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(line.querySelector('.item-price').value) || 0;
                if (description && quantity > 0 && price >= 0) {
                    productLines.push({ description, quantity, price });
                }
            });

            if (productLines.length === 0) {
                showMessageBox('Voeg alstublieft ten minste één productlijn toe.');
                return null;
            }

            return {
                clientName,
                clientVat,
                clientAddress,
                clientEmail,
                clientPhone,
                invoiceDate,
                productLines,
                totalAmountInclVat: totalAmountInclVat.toFixed(2)
            };
        }

        function renderInvoice(invoiceData) {
            const totalAmountInclVat = parseFloat(invoiceData.totalAmountInclVat);
            const amountExclVat = (totalAmountInclVat / (1 + VAT_RATE)).toFixed(2);
            const vatAmount = (totalAmountInclVat - amountExclVat).toFixed(2);
            const dueDate = new Date(invoiceData.invoiceDate);
            dueDate.setDate(dueDate.getDate() + 14);

            let itemsTableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Omschrijving</th>
                            <th>Aantal</th>
                            <th class="text-right">Prijs/stuk (incl. BTW)</th>
                            <th class="text-right">Totaal (incl. BTW)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            invoiceData.productLines.forEach(item => {
                const lineTotal = (item.quantity * item.price).toFixed(2);
                itemsTableHtml += `
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.quantity}</td>
                        <td class="text-right">&euro; ${item.price.toFixed(2)}</td>
                        <td class="text-right">&euro; ${lineTotal}</td>
                    </tr>
                `;
            });
            itemsTableHtml += `
                    </tbody>
                </table>
            `;

            const invoiceContent = `
                <img src="${companyDetails.logoUrl}" alt="Bedrijfslogo" class="company-logo" onerror="this.onerror=null;this.src='https://placehold.co/150x50/000/fff?text=Logo+Niet+Gevonden';">
                <h1 style="text-align: center; color: #2c5282; margin-bottom: 20px; font-size: 2.5rem;">Factuur</h1>
                <div class="invoice-header">
                    <div class="company-info">
                        <h3>${companyDetails.name}</h3>
                        <p>${companyDetails.address}</p>
                        <p>Telefoon: ${companyDetails.phone}</p>
                        <p>E-mail: ${companyDetails.email}</p>
                        <p>BTW nr.: ${companyDetails.vat}</p>
                    </div>
                    <div class="client-info">
                        <h3>Factuur aan:</h3>
                        <p>${invoiceData.clientName}</p>
                        <p>${invoiceData.clientAddress}</p>
                        ${invoiceData.clientVat ? `<p>BTW nr.: ${invoiceData.clientVat}</p>` : ''}
                        ${invoiceData.clientEmail ? `<p>E-mail: ${invoiceData.clientEmail}</p>` : ''}
                        ${invoiceData.clientPhone ? `<p>Telefoon: ${invoiceData.clientPhone}</p>` : ''}
                    </div>
                </div>
                <div class="invoice-details">
                    <p><strong>Factuurnummer:</strong> <span id="invoiceNumberDisplay">${invoiceData.invoiceNumber}</span></p>
                    <p><strong>Factuurdatum:</strong> ${formatDate(invoiceData.invoiceDate)}</p>
                    <p><strong>Vervaldatum:</strong> ${formatDate(dueDate.toISOString().split('T')[0])}</p>
                </div>
                <div class="invoice-body">
                    <div class="invoice-items">
                        ${itemsTableHtml}
                    </div>
                </div>
                <div class="invoice-summary">
                    <p>Subtotaal (excl. BTW): &euro; ${amountExclVat}</p>
                    <p>BTW (21%): &euro; ${vatAmount}</p>
                    <p class="total-amount">Totaal te betalen (incl. BTW): &euro; ${totalAmountInclVat.toFixed(2)}</p>
                </div>
                <div class="invoice-footer">
                    <p>Gelieve het bedrag van &euro; ${totalAmountInclVat.toFixed(2)} over te maken op rekening:</p>
                    <p><strong>Bank:</strong> ${companyDetails.bank}</p>
                    <p><strong>IBAN:</strong> ${companyDetails.iban}</p>
                    <p><strong>BIC:</strong> ${companyDetails.bic}</p>
                    <p>Met vermelding van factuurnummer ${invoiceData.invoiceNumber}.</p>
                    <p>Bedankt voor uw vertrouwen!</p>
                </div>
            `;

            document.getElementById('invoiceOutput').innerHTML = invoiceContent;
            document.getElementById('invoiceOutput').classList.remove('hidden');
        }

        function generateInvoiceNumber() {
            const currentYear = new Date().getFullYear();
            let lastInvoiceNumber = localStorage.getItem('lastInvoiceNumber');
            let sequence = 1;

            if (lastInvoiceNumber) {
                const parts = lastInvoiceNumber.split('-');
                const yearFromLast = parseInt(parts[0]);

                if (yearFromLast === currentYear) {
                    sequence = parseInt(parts[2]) + 1;
                }
            }

            const newInvoiceNumber = `${currentYear}-F-${String(sequence).padStart(3, '0')}`;
            localStorage.setItem('lastInvoiceNumber', newInvoiceNumber);
            return newInvoiceNumber;
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('nl-BE', options);
        }

        function exportInvoice() {
            window.print();
        }

        // --- Firestore Operations and UI Management ---

        function loadInvoices() {
            if (!db || !userId) {
                console.warn("Firestore of User ID niet beschikbaar om facturen te laden.");
                return;
            }

            const invoicesList = document.getElementById('savedInvoicesList');
            const loadingInvoicesElement = document.getElementById('loadingInvoices');
            const noInvoicesElement = document.getElementById('noInvoices');

            // Ensure loading message is visible initially
            if (loadingInvoicesElement) {
                loadingInvoicesElement.classList.remove('hidden');
                loadingInvoicesElement.textContent = 'Facturen laden...';
            }
            if (noInvoicesElement) {
                noInvoicesElement.classList.add('hidden'); // Hide "no invoices" initially
            }

            const invoicesColRef = collection(db, `artifacts/${__app_id}/users/${userId}/invoices`);
            const q = query(invoicesColRef, orderBy("invoiceDate", "desc")); // Order by date descending

            onSnapshot(q, (snapshot) => {
                invoicesList.innerHTML = ''; // Clear existing list *after* getting references

                if (loadingInvoicesElement) {
                    loadingInvoicesElement.classList.add('hidden'); // Hide loading once data is received
                }

                if (snapshot.empty) {
                    if (noInvoicesElement) {
                        noInvoicesElement.classList.remove('hidden');
                    }
                    return;
                } else {
                    if (noInvoicesElement) {
                        noInvoicesElement.classList.add('hidden');
                    }
                }

                snapshot.forEach(doc => {
                    const invoice = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="invoice-item-details">
                            <strong>${invoice.invoiceNumber}</strong> - ${invoice.clientName} (${formatDate(invoice.invoiceDate)}) - &euro; ${invoice.totalAmountInclVat}
                        </div>
                        <div class="invoice-item-actions">
                            <button data-invoice-id="${doc.id}" class="edit-button">Bewerken</button>
                            <button data-invoice-id="${doc.id}" class="delete-button">Verwijderen</button>
                            <button data-invoice-id="${doc.id}" class="export-list-button">Exporteren</button>
                        </div>
                    `;
                    invoicesList.appendChild(li);
                });

                // Attach event listeners to the dynamically created buttons
                invoicesList.querySelectorAll('.edit-button').forEach(button => {
                    button.addEventListener('click', (event) => editInvoice(event.target.dataset.invoiceId));
                });
                invoicesList.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', (event) => deleteInvoice(event.target.dataset.invoiceId));
                });
                // Attach event listener for the new export button
                invoicesList.querySelectorAll('.export-list-button').forEach(button => {
                    button.addEventListener('click', (event) => exportSpecificInvoice(event.target.dataset.invoiceId));
                });

            }, (error) => {
                console.error("Fout bij het laden van facturen: ", error);
                if (loadingInvoicesElement) {
                    loadingInvoicesElement.textContent = 'Fout bij het laden van facturen.';
                    loadingInvoicesElement.classList.remove('hidden'); // Ensure error message is visible
                }
                if (noInvoicesElement) {
                    noInvoicesElement.classList.add('hidden'); // Hide no invoices if there's an error
                }
            });
        }

        async function exportSpecificInvoice(invoiceId) {
            if (!db || !userId) {
                showMessageBox('Authenticatie is nog niet voltooid. Kan factuur niet exporteren.');
                return;
            }

            try {
                const invoiceDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/invoices`, invoiceId);
                const invoiceSnap = await getDoc(invoiceDocRef);

                if (invoiceSnap.exists()) {
                    const invoiceData = invoiceSnap.data();
                    renderInvoice(invoiceData); // Render the specific invoice
                    // Wait a moment for rendering to complete before printing
                    setTimeout(() => {
                        window.print();
                        // Optionally hide the invoice output after printing
                        document.getElementById('invoiceOutput').classList.add('hidden');
                    }, 500); // Small delay
                } else {
                    showMessageBox('Factuur niet gevonden voor export.');
                }
            } catch (error) {
                console.error("Fout bij het exporteren van factuur: ", error);
                showMessageBox('Fout bij het exporteren van factuur.');
            }
        }

        async function editInvoice(invoiceId) {
            if (!db || !userId) {
                showMessageBox('Authenticatie is nog niet voltooid. Kan factuur niet bewerken.');
                return;
            }

            try {
                const invoiceDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/invoices`, invoiceId);
                const invoiceSnap = await getDoc(invoiceDocRef);

                if (invoiceSnap.exists()) {
                    const invoiceData = invoiceSnap.data();
                    currentEditingInvoiceId = invoiceId; // Set the ID of the invoice being edited

                    // Populate form fields
                    document.getElementById('clientName').value = invoiceData.clientName || '';
                    document.getElementById('clientVat').value = invoiceData.clientVat || '';
                    document.getElementById('clientAddress').value = invoiceData.clientAddress || '';
                    document.getElementById('clientEmail').value = invoiceData.clientEmail || '';
                    document.getElementById('clientPhone').value = invoiceData.clientPhone || '';
                    document.getElementById('invoiceDate').value = invoiceData.invoiceDate || '';

                    // Clear existing product lines
                    const productLinesContainer = document.getElementById('productLinesContainer');
                    productLinesContainer.innerHTML = '';
                    productLineCounter = 0; // Reset counter for new product line IDs

                    // Add product lines from saved data
                    if (invoiceData.productLines && invoiceData.productLines.length > 0) {
                        invoiceData.productLines.forEach(item => {
                            addProductLine(item.description, item.quantity, item.price);
                        });
                    } else {
                        addProductLine(); // Add a default empty line if none exist
                    }

                    calculateTotalAmount(); // Ensure total is calculated after populating

                    // Show update button, hide generate button
                    document.getElementById('generateInvoiceBtn').style.display = 'none';
                    document.getElementById('updateInvoiceBtn').style.display = 'inline-block';

                    // Hide generated invoice preview if visible
                    document.getElementById('invoiceOutput').classList.add('hidden');

                    showMessageBox(`Factuur ${invoiceData.invoiceNumber} geladen voor bewerking.`);
                } else {
                    showMessageBox('Factuur niet gevonden.');
                }
            } catch (error) {
                console.error("Fout bij het laden van factuur voor bewerking: ", error);
                showMessageBox('Fout bij het laden van factuur voor bewerking.');
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!db || !userId) {
                showMessageBox('Authenticatie is nog niet voltooid. Kan factuur niet verwijderen.');
                return;
            }

            // Custom confirmation dialog
            const confirmDelete = await new Promise(resolve => {
                const confirmBox = document.createElement('div');
                confirmBox.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    text-align: center;
                    max-width: 300px;
                    border: 1px solid #ccc;
                `;
                confirmBox.innerHTML = `
                    <p>Weet u zeker dat u deze factuur wilt verwijderen?</p>
                    <div style="margin-top: 15px;">
                        <button id="confirmYes" style="margin-right: 10px; padding: 8px 15px; background-color: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer;">Ja</button>
                        <button id="confirmNo" style="padding: 8px 15px; background-color: #63b3ed; color: white; border: none; border-radius: 5px; cursor: pointer;">Nee</button>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                document.getElementById('confirmYes').onclick = () => {
                    document.body.removeChild(confirmBox);
                    resolve(true);
                };
                document.getElementById('confirmNo').onclick = () => {
                    document.body.removeChild(confirmBox);
                    resolve(false);
                };
            });

            if (!confirmDelete) {
                return; // User cancelled deletion
            }

            try {
                const invoiceDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/invoices`, invoiceId);
                await deleteDoc(invoiceDocRef);
                showMessageBox('Factuur succesvol verwijderd!');
                clearForm(); // Clear form if the deleted invoice was being edited
            } catch (error) {
                console.error("Fout bij het verwijderen van factuur: ", error);
                showMessageBox('Fout bij het verwijderen van factuur.');
            }
        }

        function clearForm() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientVat').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('invoiceDate').valueAsDate = new Date(); // Reset to current date

            // Clear and reset product lines
            const productLinesContainer = document.getElementById('productLinesContainer');
            productLinesContainer.innerHTML = '';
            productLineCounter = 0;
            addProductLine(); // Add one default empty product line

            document.getElementById('totalAmountDisplay').value = '0.00';
            document.getElementById('invoiceOutput').classList.add('hidden');

            // Switch back to generate mode
            document.getElementById('generateInvoiceBtn').style.display = 'inline-block';
            document.getElementById('updateInvoiceBtn').style.display = 'none';
            currentEditingInvoiceId = null; // Clear editing state
        }

        // Custom message box function (replaces alert() and confirm())
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
                max-width: 300px;
                border: 1px solid #ccc;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button style="margin-top: 15px; padding: 8px 15px; background-color: #63b3ed; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
            `;
            document.body.appendChild(messageBox);

            messageBox.querySelector('button').onclick = () => {
                document.body.removeChild(messageBox);
            };
        }
    </script>
</body>
</html>
